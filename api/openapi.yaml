openapi: 3.1.0
info:
  description: "\nREST API for electronic invoicing in France: Factur-X, AFNOR PDP/PA,\
    \ electronic signatures.\n\n## üéØ Main Features\n\n### üìÑ Factur-X Invoice Generation\n\
    - **Formats**: XML only or PDF/A-3 with embedded XML\n- **Profiles**: MINIMUM,\
    \ BASIC, EN16931, EXTENDED\n- **Standards**: EN 16931 (EU directive 2014/55),\
    \ ISO 19005-3 (PDF/A-3), CII (UN/CEFACT)\n- **üÜï Simplified Format**: Generation\
    \ from SIRET + auto-enrichment (Chorus Pro API + Business Search)\n\n### ‚úÖ Validation\
    \ and Compliance\n- **XML Validation**: Schematron (45 to 210+ rules depending\
    \ on profile)\n- **PDF Validation**: PDF/A-3, Factur-X XMP metadata, electronic\
    \ signatures\n- **VeraPDF**: Strict PDF/A validation (146+ ISO 19005-3 rules)\n\
    - **Asynchronous Processing**: Celery support for heavy validations (VeraPDF)\n\
    \n### üì° AFNOR PDP/PA Integration (XP Z12-013)\n- **Flow Submission**: Send invoices\
    \ to Partner Dematerialization Platforms\n- **Flow Search**: View submitted invoices\n\
    - **Download**: Retrieve PDF/A-3 with XML\n- **Directory Service**: Company search\
    \ (SIREN/SIRET)\n- **Multi-client**: Support for multiple PDP configs per user\
    \ (stored credentials or zero-storage)\n\n### ‚úçÔ∏è PDF Electronic Signature\n- **Standards**:\
    \ PAdES-B-B, PAdES-B-T (RFC 3161 timestamping), PAdES-B-LT (long-term archival)\n\
    - **eIDAS Levels**: SES (self-signed), AdES (commercial CA), QES (QTSP)\n- **Validation**:\
    \ Cryptographic integrity and certificate verification\n- **Certificate Generation**:\
    \ Self-signed X.509 certificates for testing\n\n### üîÑ Asynchronous Processing\n\
    - **Celery**: Asynchronous generation, validation and signing\n- **Polling**:\
    \ Status tracking via `/tasks/{task_id}/status`\n- **No timeout**: Ideal for large\
    \ files or heavy validations\n\n## üîí Authentication\n\nAll requests require a\
    \ **JWT token** in the Authorization header:\n```\nAuthorization: Bearer YOUR_JWT_TOKEN\n\
    ```\n\n### How to obtain a JWT token?\n\n#### üîë Method 1: `/api/token/` API (Recommended)\n\
    \n**URL:** `https://www.factpulse.fr/api/token/`\n\nThis method is **recommended**\
    \ for integration in your applications and CI/CD workflows.\n\n**Prerequisites:**\
    \ Having set a password on your account\n\n**For users registered via email/password:**\n\
    - You already have a password, use it directly\n\n**For users registered via OAuth\
    \ (Google/GitHub):**\n- You must first set a password at: https://www.factpulse.fr/accounts/password/set/\n\
    - Once the password is created, you can use the API\n\n**Request example:**\n\
    ```bash\ncurl -X POST https://www.factpulse.fr/api/token/ \\\n  -H \"Content-Type:\
    \ application/json\" \\\n  -d '{\n    \"username\": \"your_email@example.com\"\
    ,\n    \"password\": \"your_password\"\n  }'\n```\n\n**Optional `client_uid` parameter:**\n\
    \nTo select credentials for a specific client (PA/PDP, Chorus Pro, signing certificates),\
    \ add `client_uid`:\n\n```bash\ncurl -X POST https://www.factpulse.fr/api/token/\
    \ \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"username\": \"\
    your_email@example.com\",\n    \"password\": \"your_password\",\n    \"client_uid\"\
    : \"550e8400-e29b-41d4-a716-446655440000\"\n  }'\n```\n\nThe `client_uid` will\
    \ be included in the JWT and allow the API to automatically use:\n- AFNOR/PDP\
    \ credentials configured for this client\n- Chorus Pro credentials configured\
    \ for this client\n- Electronic signature certificates configured for this client\n\
    \n**Response:**\n```json\n{\n  \"access\": \"eyJ0eXAiOiJKV1QiLCJhbGc...\",  //\
    \ Access token (validity: 30 min)\n  \"refresh\": \"eyJ0eXAiOiJKV1QiLCJhbGc...\"\
    \  // Refresh token (validity: 7 days)\n}\n```\n\n**Advantages:**\n- ‚úÖ Full automation\
    \ (CI/CD, scripts)\n- ‚úÖ Programmatic token management\n- ‚úÖ Refresh token support\
    \ for automatic access renewal\n- ‚úÖ Easy integration in any language/tool\n\n\
    #### üñ•Ô∏è Method 2: Dashboard Generation (Alternative)\n\n**URL:** https://www.factpulse.fr/dashboard/\n\
    \nThis method is suitable for quick tests or occasional use via the graphical\
    \ interface.\n\n**How it works:**\n- Log in to the dashboard\n- Use the \"Generate\
    \ Test Token\" or \"Generate Production Token\" buttons\n- Works for **all** users\
    \ (OAuth and email/password), without requiring a password\n\n**Token types:**\n\
    - **Test Token**: 24h validity, 1000 calls/day quota (free)\n- **Production Token**:\
    \ 7 days validity, quota based on your plan\n\n**Advantages:**\n- ‚úÖ Quick for\
    \ API testing\n- ‚úÖ No password required\n- ‚úÖ Simple visual interface\n\n**Disadvantages:**\n\
    - ‚ùå Requires manual action\n- ‚ùå No refresh token\n- ‚ùå Less suited for automation\n\
    \n### üìö Full Documentation\n\nFor more information on authentication and API\
    \ usage:\nhttps://www.factpulse.fr/documentation-api/\n    "
  title: FactPulse REST API
  version: 1.0.0
servers:
- url: /
tags:
- description: "\n## üìÑ Electronic invoice generation and validation\n\n**Main API\
    \ for generating Factur-X invoices compliant with European standards.**\n\n###\
    \ Features\n\n- **Factur-X Generation**: MINIMUM, BASIC, EN16931, EXTENDED profiles\n\
    - **Validation**: Schematron (45 to 210+ rules), VeraPDF (146+ PDF/A-3 rules)\n\
    - **Electronic Signature**: PAdES-B-B, PAdES-B-T, PAdES-B-LT (eIDAS levels)\n\
    - **Asynchronous Processing**: Celery support for large files\n- **Auto-enrichment**:\
    \ Data from Chorus Pro + Business API\n        "
  name: Invoice Processing
- description: "\n## üîë OAuth2 Authentication for AFNOR PDP\n\n**Endpoint to obtain\
    \ an OAuth2 token for authentication with Partner Dematerialization Platforms.**\n\
    \n### Usage\n\nThis endpoint allows you to obtain an OAuth2 access token required\
    \ to call Flow Service and Directory Service APIs.\n\n**Request Type**: `application/x-www-form-urlencoded`\n\
    \n**Parameters**:\n- `grant_type`: `client_credentials` (required)\n- `client_id`:\
    \ Client ID provided by the PDP (required)\n- `client_secret`: Client secret provided\
    \ by the PDP (required)\n\n**Response**:\n```json\n{\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\
    ,\n  \"token_type\": \"Bearer\",\n  \"expires_in\": 3600\n}\n```\n\n**Note**:\
    \ This token must be used in the `Authorization: Bearer {access_token}` header\
    \ for AFNOR API calls.\n        "
  name: AFNOR PDP/PA
- description: "\n## üîê AFNOR PDP Authentication Modes\n\n**All AFNOR Flow Service\
    \ endpoints support 2 authentication modes:**\n\n### Mode 1: Stored (Stored Credentials)\n\
    - PDP credentials are stored encrypted in Django\n- Automatically retrieved via\
    \ JWT `client_uid`\n- **Django decides** the environment (test/production via\
    \ configured URLs)\n- Convenient for production\n\n**Example**:\n```json\n{\n\
    \  \"name\": \"Invoice INV-2025-001\",\n  \"flowSyntax\": \"CII\",\n  \"flowProfile\"\
    : \"EN16931\"\n}\n```\n\n**JWT must contain**: `client_uid` claim pointing to\
    \ a registered PDP config\n\n---\n\n### Mode 2: Zero-Trust (Zero-Storage)\n- PDP\
    \ credentials are passed in the `pdp_credentials` field of each request\n- Never\
    \ stored in database\n- **Client decides** the environment via URLs in credentials\n\
    - Maximum security, GDPR compliant\n\n**Example**:\n```json\n{\n  \"name\": \"\
    Invoice INV-2025-001\",\n  \"flowSyntax\": \"CII\",\n  \"flowProfile\": \"EN16931\"\
    ,\n  \"pdp_credentials\": {\n    \"flow_service_url\": \"https://pdp-production.example.fr/flow/v1\"\
    ,\n    \"token_url\": \"https://auth.example.fr/oauth/token\",\n    \"client_id\"\
    : \"client_prod_123\",\n    \"client_secret\": \"secret_prod_456\",\n    \"directory_service_url\"\
    : \"https://pdp-production.example.fr/directory/v1\"\n  }\n}\n```\n\n---\n\n**PDPCredentials\
    \ Schema**:\n- `flow_service_url`: Flow Service API URL (invoice submission/search)\n\
    - `token_url`: OAuth2 URL to obtain token\n- `client_id`: OAuth2 Client ID provided\
    \ by PDP\n- `client_secret`: OAuth2 Client Secret provided by PDP\n- `directory_service_url`:\
    \ (Optional) Directory Service API URL\n\n**Note**: All endpoints below support\
    \ these 2 modes. The `pdp_credentials` field is optional in each request.\n\nüìñ\
    \ **Full documentation**: See `OPENAPI_AUTHENTICATION_MODES.md`\n        "
  name: AFNOR PDP/PA - Flow Service
- description: "\n## üîê AFNOR Directory Service Authentication Modes\n\nSupports the\
    \ **same 2 authentication modes** as Flow Service.\n\n### Mode 1: Stored\nJWT\
    \ with `client_uid` ‚Üí Credentials retrieved from Django\n\n### Mode 2: Zero-Trust\n\
    PDP credentials passed in `pdp_credentials` (see Flow Service)\n\nüìñ **Full documentation**:\
    \ See \"AFNOR PDP/PA - Flow Service\" tag above\n        "
  name: AFNOR PDP/PA - Directory Service
- description: "\n## üîê Electronic Signature Authentication Modes\n\n**All electronic\
    \ signature endpoints support 2 authentication modes:**\n\n### Mode 1: Stored\
    \ (Stored Credentials)\n- Signing certificates are stored encrypted in Django\n\
    - Automatically retrieved via JWT `client_uid`\n- **Django decides** the environment\
    \ (test or eIDAS qualified certificate)\n- Convenient for production\n\n**Example**:\n\
    ```json\n{\n  \"pdf_base64\": \"JVBERi0xLjQKJeLjz9MK...\",\n  \"filename\": \"\
    invoice.pdf\",\n  \"signature_reason\": \"Official invoice\",\n  \"signature_location\"\
    : \"Paris, France\",\n  \"contact_info\": \"contact@company.fr\"\n}\n```\n\n**JWT\
    \ must contain**: `client_uid` claim pointing to a registered certificate\n\n\
    ---\n\n### Mode 2: Zero-Trust\n- Certificate credentials are passed in the `certificate_credentials`\
    \ field of each request\n- Never stored in database\n- **Client decides** the\
    \ certificate type (test or eIDAS qualified)\n- Maximum security, GDPR compliant\n\
    \n**Example**:\n```json\n{\n  \"certificate_credentials\": {\n    \"certificate_base64\"\
    : \"MIIE...\",\n    \"private_key_base64\": \"MIIE...\",\n    \"password\": \"\
    cert_password\",\n    \"timestamp_url\": \"http://timestamp.digicert.com\",\n\
    \    \"use_qualified_certificate\": true\n  },\n  \"pdf_base64\": \"JVBERi0xLjQKJeLjz9MK...\"\
    ,\n  \"filename\": \"invoice.pdf\",\n  \"signature_reason\": \"Official invoice\"\
    ,\n  \"signature_location\": \"Paris, France\",\n  \"contact_info\": \"contact@company.fr\"\
    \n}\n```\n\n---\n\n**CertificateCredentials Schema**:\n- `certificate_base64`:\
    \ Base64-encoded X.509 certificate\n- `private_key_base64`: Base64-encoded private\
    \ key\n- `password`: Private key password (if encrypted)\n- `timestamp_url`: Timestamp\
    \ server URL (TSA)\n- `use_qualified_certificate`: `true` = eIDAS qualified certificate,\
    \ `false` = test certificate\n\n**Note**: All endpoints below support these 2\
    \ modes. The `certificate_credentials` field is optional in each request.\n\nüìñ\
    \ **Full documentation**: See `OPENAPI_AUTHENTICATION_MODES.md`\n        "
  name: Electronic Signature
- description: "\n## üîê Chorus Pro Authentication Modes\n\n**All Chorus Pro endpoints\
    \ support 2 authentication modes:**\n\n### Mode 1: Stored (Stored Credentials)\n\
    - Credentials are stored encrypted in Django\n- Automatically retrieved via JWT\
    \ `client_uid`\n- **Django decides** the environment (sandbox/production)\n- Convenient\
    \ for production\n\n**Example**:\n```json\n{\n  \"structure_identifier\": \"12345678901234\"\
    ,\n  \"structure_identifier_type\": \"SIRET\"\n}\n```\n\n**JWT must contain**:\
    \ `client_uid` claim pointing to a registered Chorus Pro config\n\n---\n\n###\
    \ Mode 2: Zero-Trust\n- Credentials are passed in the `credentials` field of each\
    \ request\n- Never stored in database\n- **Client decides** the environment via\
    \ `\"sandbox\": true/false`\n- Maximum security, GDPR compliant\n\n**Example**:\n\
    ```json\n{\n  \"credentials\": {\n    \"piste_client_id\": \"my_client_id\",\n\
    \    \"piste_client_secret\": \"my_secret\",\n    \"chorus_pro_login\": \"login@company.fr\"\
    ,\n    \"chorus_pro_password\": \"password\",\n    \"sandbox\": true\n  },\n \
    \ \"structure_identifier\": \"12345678901234\",\n  \"structure_identifier_type\"\
    : \"SIRET\"\n}\n```\n\n---\n\n**ChorusProCredentials Schema**:\n- `piste_client_id`:\
    \ PISTE Client ID (government OAuth2 portal)\n- `piste_client_secret`: PISTE Client\
    \ Secret\n- `chorus_pro_login`: Chorus Pro login\n- `chorus_pro_password`: Chorus\
    \ Pro password\n- `sandbox`: `true` = test environment, `false` = production\n\
    \n**Note**: All endpoints below support these 2 modes. The `credentials` field\
    \ is optional in each request.\n\nüìñ **Full documentation**: See `OPENAPI_AUTHENTICATION_MODES.md`\n\
    \        "
  name: Chorus Pro
- description: "\n## üîç PDF/XML Factur-X Consistency Verification\n\n**Verifies that\
    \ visible data in the PDF matches the embedded Factur-X XML.**\n\n### Features\n\
    \n- **Native PDF Extraction**: Fast, uses pdfplumber to extract text\n- **OCR\
    \ Extraction**: DocTR service for image PDFs (asynchronous)\n- **Comparison**:\
    \ Compares extracted PDF data with Factur-X XML\n- **Discrepancy Report**: List\
    \ of differences with severity level (CRITICAL, WARNING, INFO)\n\n### Verified\
    \ Fields\n\n**Identification**: BT-1 (invoice #), BT-2 (date), BT-3 (type), BT-5\
    \ (currency)\n\n**Parties**:\n- Seller: BT-27 (name), BT-29 (SIRET), BT-30 (SIREN),\
    \ BT-31 (VAT)\n- Buyer: BT-44 (name), BT-46 (SIRET), BT-47 (SIREN), BT-48 (VAT)\n\
    \n**Amounts**: BT-109 (excl. tax), BT-110 (VAT), BT-112 (incl. tax), BT-115 (amount\
    \ due)\n\n**Mandatory Notes**: PMT (recovery fees), PMD (late payment penalties),\
    \ AAB (discount)\n\n### Endpoints\n\n- **POST /verify**: Synchronous verification\
    \ (native PDF only)\n- **POST /verify-async**: Asynchronous verification (with\
    \ OCR if needed)\n- **GET /verify-async/{id}/status**: Async verification status\n\
    - **POST /extract**: Extraction only (without XML comparison)\n        "
  name: PDF/XML Verification
paths:
  /api/v1/processing/generate-invoice:
    post:
      description: |-
        Generates an electronic invoice in Factur-X format compliant with European standards.

        ## Applied Standards

        - **Factur-X** (France): FNFE-MPE standard (Forum National de la Facture √âlectronique)
        - **ZUGFeRD** (Germany): German format compatible with Factur-X
        - **EN 16931**: European semantic standard for electronic invoicing
        - **ISO 19005-3** (PDF/A-3): Long-term electronic archiving
        - **Cross Industry Invoice (CII)**: UN/CEFACT XML syntax

        ## üÜï New: Simplified format with auto-enrichment (P0.1)

        You can now create an invoice by providing only:
        - An invoice number
        - A sender SIRET + **IBAN** (required)
        - A recipient SIRET
        - Invoice lines (description, quantity, net price)

        **Simplified format example**:
        ```json
        {
          "number": "FACT-2025-001",
          "sender": {
            "siret": "92019522900017",
            "iban": "FR7630001007941234567890185"
          },
          "recipient": {"siret": "35600000000048"},
          "lines": [
            {"description": "Service", "quantity": 10, "unitPrice": 100.00, "vatRate": 20.0}
          ]
        }
        ```

        **‚ö†Ô∏è Required fields (simplified format)**:
        - `number`: Unique invoice number
        - `sender.siret`: Sender's SIRET (14 digits)
        - `sender.iban`: Bank account IBAN (no public API to retrieve it)
        - `recipient.siret`: Recipient's SIRET
        - `lines[]`: At least one invoice line

        **What happens automatically with `auto_enrich=True`**:
        - ‚úÖ Name enrichment from Chorus Pro API
        - ‚úÖ Address enrichment from Business Search API (free, public)
        - ‚úÖ Automatic intra-EU VAT calculation (FR + key + SIREN)
        - ‚úÖ Chorus Pro ID retrieval for electronic invoicing
        - ‚úÖ Net/VAT/Gross totals calculation
        - ‚úÖ Date generation (today + 30-day due date)
        - ‚úÖ Multi-rate VAT handling

        **Supported identifiers**:
        - SIRET (14 digits): Specific establishment ‚≠ê Recommended
        - SIREN (9 digits): Company (auto-selection of headquarters)
        - Special types: UE_HORS_FRANCE, RIDET, TAHITI, etc.

        ## Checks performed during generation

        ### 1. Data validation (Pydantic)
        - Data types (amounts as Decimal, ISO 8601 dates)
        - Formats (14-digit SIRET, 9-digit SIREN, IBAN)
        - Required fields per profile
        - Amount consistency (Net + VAT = Gross)

        ### 2. CII-compliant XML generation
        - Serialization according to Cross Industry Invoice XSD schema
        - Correct UN/CEFACT namespaces
        - Hierarchical structure respected
        - UTF-8 encoding without BOM

        ### 3. Schematron validation
        - Business rules for selected profile (MINIMUM, BASIC, EN16931, EXTENDED)
        - Element cardinality (required, optional, repeatable)
        - Calculation rules (totals, VAT, discounts)
        - European EN 16931 compliance

        ### 4. PDF/A-3 conversion (if output_format='pdf')
        - Source PDF conversion to PDF/A-3 via Ghostscript
        - Factur-X XML embedding in PDF
        - Compliant XMP metadata
        - ICC sRGB color profile
        - Removal of forbidden elements (JavaScript, forms)

        ## How it works

        1. **Submission**: Invoice is queued in Celery for asynchronous processing
        2. **Immediate return**: You receive a `task_id` (HTTP 202 Accepted)
        3. **Tracking**: Use the `/tasks/{task_id}/status` endpoint to track progress

        ## Output formats

        - **xml**: Generates only Factur-X XML (recommended for testing)
        - **pdf**: Generates PDF/A-3 with embedded XML (requires `source_pdf`)

        ## Factur-X profiles

        - **MINIMUM**: Minimal data (simplified invoice)
        - **BASIC**: Basic information (SMEs)
        - **EN16931**: European standard (recommended, compliant with directive 2014/55/EU)
        - **EXTENDED**: All available data (large accounts)

        ## What you get

        After successful processing (status `completed`):
        - **XML only**: Base64-encoded Factur-X compliant XML file
        - **PDF/A-3**: PDF with embedded XML, ready for sending/archiving
        - **Metadata**: Profile, Factur-X version, file size
        - **Validation**: Schematron compliance confirmation

        ## Validation

        Data is automatically validated according to detected format.
        On error, a 422 status is returned with invalid field details.
      operationId: generate_invoice_api_v1_processing_generate_invoice_post
      requestBody:
        content:
          multipart/form-data:
            examples:
              complete_example:
                summary: Complete invoice example
                value:
                  invoice_data: |-
                    {
                      "invoiceNumber": "FACT-2025-001",
                      "invoiceDate": "2025-10-27",
                      "paymentDueDate": "2025-11-27",
                      "submissionMode": "DEPOT_PDF_API",
                      "recipient": {
                        "name": "Client Test SAS",
                        "electronicAddress": {
                          "identifier": "12345678901234",
                          "schemeId": "0225"
                        },
                        "postalAddress": {
                          "lineOne": "456 Avenue des Champs",
                          "postalCode": "69001",
                          "city": "Lyon",
                          "countryCode": "FR"
                        },
                        "executingServiceCode": "SERVICE01"
                      },
                      "supplier": {
                        "name": "Ma Soci\u00e9t\u00e9 SAS",
                        "supplierId": 12345,
                        "siret": "12345678900001",
                        "vatNumber": "FR12345678900",
                        "iban": "FR7630006000011234567890189",
                        "electronicAddress": {
                          "identifier": "12345678900001",
                          "schemeId": "0225"
                        },
                        "postalAddress": {
                          "lineOne": "123 Rue de la R\u00e9publique",
                          "lineTwo": "B\u00e2timent A",
                          "postalCode": "75001",
                          "city": "Paris",
                          "countryCode": "FR"
                        }
                      },
                      "invoicingFramework": {
                        "invoicingFrameworkCode": "A1_FACTURE_FOURNISSEUR"
                      },
                      "references": {
                        "invoiceType": "FACTURE",
                        "vatAccountingCode": "TVA_SUR_DEBIT",
                        "paymentMeans": "VIREMENT",
                        "invoiceCurrency": "EUR",
                        "purchaseOrderReference": "CMD-2025-042"
                      },
                      "invoiceLines": [
                        {
                          "lineNumber": 1,
                          "itemName": "Prestation de conseil",
                          "quantity": "5.00",
                          "unit": "HEURE",
                          "unitNetPrice": "200.00",
                          "lineNetAmount": "1000.00",
                          "manualVatRate": "20.00",
                          "vatCategory": "S",
                          "reference": "REF-CONSEIL-001"
                        },
                        {
                          "lineNumber": 2,
                          "itemName": "Formation d\u00e9veloppeurs",
                          "quantity": "3.00",
                          "unit": "JOUR",
                          "unitNetPrice": "500.00",
                          "lineNetAmount": "1500.00",
                          "vatCategory": "S",
                          "manualVatRate": "20.00",
                          "reference": "REF-FORM-002"
                        }
                      ],
                      "vatLines": [
                        {
                          "taxableAmount": "2500.00",
                          "vatAmount": "500.00",
                          "manualRate": "20.00",
                          "category": "S"
                        }
                      ],
                      "totals": {
                        "totalNetAmount": "2500.00",
                        "vatAmount": "500.00",
                        "totalGrossAmount": "3000.00",
                        "amountDue": "3000.00"
                      },
                      "comment": "Invoice for October 2025 services"
                    }
                  profile: EXTENDED
                  output_format: xml
            schema:
              $ref: "#/components/schemas/generate_invoice_api_v1_processing_generate_invoice_post_request"
        required: true
      responses:
        "202":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
          description: Successful Response
        "400":
          description: Invalid invoice data or missing PDF file
        "422":
          description: Invoice data validation error
      security:
      - HTTPBearer: []
      summary: Generate a Factur-X invoice
      tags:
      - Invoice Processing
      x-facture-facturx-schema:
        $ref: "#/components/schemas/FactureFacturX"
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/tasks/{task_id}/status:
    get:
      description: |-
        Retrieves the progress status of an invoice generation task.

        ## Possible states

        The `status` field uses the `CeleryStatus` enum with values:
        - **PENDING, STARTED, SUCCESS, FAILURE, RETRY**

        See the `CeleryStatus` schema documentation for details.

        ## Business result

        When `status="SUCCESS"`, the `result` field contains:
        - `status`: "SUCCESS" or "ERROR" (business result)
        - `content_b64`: Base64 encoded content (if success)
        - `errorCode`, `errorMessage`, `details`: AFNOR format (if business error)

        ## Usage

        Poll this endpoint every 2-3 seconds until
        `status` is `SUCCESS` or `FAILURE`.
      operationId: get_task_status_api_v1_processing_tasks__task_id__status_get
      parameters:
      - explode: false
        in: path
        name: task_id
        required: true
        schema:
          title: Task Id
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AsyncTaskStatus"
          description: Current task state
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Get task generation status
      tags:
      - Invoice Processing
      x-accepts:
      - application/json
  /api/v1/processing/validate-xml:
    post:
      description: |-
        Validates a Factur-X XML file against Schematron business rules according to EN 16931 standard.

        ## Applied Standard

        **Schematron ISO/IEC 19757-3**: Business rules validation language for XML
        - Semantic validation (beyond XSD syntax)
        - European EN 16931 business rules
        - French-specific Factur-X rules
        - Arithmetic calculations and data consistency

        ## Profiles and validated rules

        ### MINIMUM (45 rules)
        - Unique invoice identifier
        - Dates (issue, due date)
        - Party identifiers (SIRET/SIREN)
        - Total gross amount

        ### BASIC (102 rules)
        - All MINIMUM rules
        - Detailed invoice lines
        - Basic VAT calculations
        - Payment methods
        - References (order, contract)

        ### EN16931 (178 rules)
        - All BASIC rules
        - **European rules (BR-xx)**: 81 business rules
        - **French rules (FR-xx)**: 12 France-specific rules
        - **Advanced calculations (CR-xx)**: 32 calculation rules
        - **Standardized codes (CL-xx)**: 52 code lists

        ### EXTENDED (210+ rules)
        - All EN16931 rules
        - Logistics information
        - Advanced accounting data
        - Multiple external references

        ## Checks performed

        ### 1. Syntax validation
        - Correct XML parsing (UTF-8, well-formed)
        - UN/CEFACT namespaces present
        - Hierarchical structure respected

        ### 2. Business rules (BR-xx)
        Examples:
        - `BR-1`: Invoice total must equal sum of line totals + document-level amounts
        - `BR-CO-10`: Sum of VAT base amounts must equal invoice net total
        - `BR-16`: Invoice currency code must be in ISO 4217 list

        ### 3. French rules (FR-xx)
        Examples:
        - `FR-1`: Supplier SIRET must have 14 digits
        - `FR-2`: Customer SIRET must have 14 digits (if present)
        - `FR-5`: Intra-EU VAT number must be in format FRxx999999999

        ### 4. Calculation rules (CR-xx)
        - Net + VAT = Gross amounts
        - Sum of lines = Document total
        - Discounts and surcharges correctly applied
        - Compliant rounding (2 decimals for amounts)

        ### 5. Standardized codes (CL-xx)
        - ISO 3166-1 alpha-2 country codes
        - ISO 4217 currency codes
        - UN/ECE Rec 20 measurement units
        - VAT codes (types, categories, exemptions)
        - SchemeID for identifiers (0002=SIREN, 0009=SIRET, etc.)

        ## Validation process

        1. **XSLT loading**: Schematron file converted to XSLT (Saxon-HE)
        2. **Transformation**: Rules applied to XML
        3. **Results analysis**: Extraction of errors (`failed-assert`) and warnings (`successful-report`)
        4. **Report**: Structured list of non-conformities

        ## Responses

        **200 OK**: Compliant XML
        ```json
        {
          "message": "XML is compliant with EN16931 profile"
        }
        ```

        **400 Bad Request**: Non-compliant XML
        ```json
        {
          "detail": [
            "[BR-1] Invoice total (120.00) does not match calculated sum (100.00 + 20.00)",
            "[FR-1] Supplier SIRET must contain exactly 14 digits"
          ]
        }
        ```

        ## Use cases

        - **Pre-validation**: Verify XML before PDF/A integration
        - **Debugging**: Precisely identify generation errors
        - **Testing**: Validate test or example XMLs
        - **Compliance**: Ensure European and French rules are met
        - **Development**: Quick testing without PDF generation

        ## Processing time

        - MINIMUM profile: ~0.5 second
        - EN16931 profile: ~1-2 seconds
        - EXTENDED profile: ~2-3 seconds
      operationId: validate_xml_api_v1_processing_validate_xml_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_validate_xml_api_v1_processing_validate_xml_post"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationSuccessResponse"
          description: Successful Response
        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
          description: XML does not comply with Factur-X profile rules
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Validate an existing Factur-X XML
      tags:
      - Invoice Processing
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/validate-facturx-pdf:
    post:
      description: |-
        Validates a complete Factur-X PDF according to European and French standards.

        ## Applied validation standards

        - **EN 16931**: European semantic standard (directive 2014/55/EU)
        - **ISO 19005-3** (PDF/A-3): Long-term electronic archiving
        - **Factur-X / ZUGFeRD**: Franco-German specification
        - **Schematron**: XML business rules validation
        - **eIDAS**: European regulation on electronic identification (signatures)

        ## Checks performed

        ### 1. Factur-X XML extraction and validation
        **Checks performed:**
        - Presence of embedded XML file (`factur-x.xml` or `zugferd-invoice.xml`)
        - Automatic profile detection (MINIMUM, BASIC, EN16931, EXTENDED)
        - XML parsing with UTF-8 validation
        - GuidelineSpecifiedDocumentContextParameter/ID extraction

        **Schematron validation:**
        - Business rules for detected profile (MINIMUM: 45 rules, EN16931: 178 rules)
        - Cardinality of required elements
        - Calculation consistency (net, VAT, gross amounts, discounts)
        - Identifier formats (SIRET, intra-EU VAT, IBAN)
        - Standardized codes (ISO country codes, UN/ECE units, VAT codes)

        **What is verified:**
        - ‚úÖ XML structure conforming to Cross Industry Invoice XSD
        - ‚úÖ Correct UN/CEFACT namespace
        - ‚úÖ European business rules (BR-xx)
        - ‚úÖ French-specific rules (FR-xx)

        ### 2. PDF/A-3 compliance
        **Basic validation (metadata):**
        - Presence of `/Type` field set to `Catalog`
        - Metadata `pdfaid:part` = 3 (PDF/A-3)
        - Metadata `pdfaid:conformance` = B or U
        - PDF version >= 1.4

        **Strict VeraPDF validation (if use_verapdf=True):**
        - 146+ ISO 19005-3 rules (PDF/A-3B)
        - Absence of forbidden content (JavaScript, multimedia, dynamic forms)
        - Correctly embedded fonts and subsets
        - Compliant color spaces (sRGB, DeviceGray)
        - Valid file structure (cross-reference table)
        - XMP metadata conforming to ISO 16684-1

        **What is verified:**
        - ‚úÖ Long-term archivable file (20+ years)
        - ‚úÖ Guaranteed readability (embedded fonts)
        - ‚úÖ Legal compliance (France, Germany, EU)

        ### 3. XMP metadata (eXtensible Metadata Platform)
        **Checks performed:**
        - Presence of `<?xpacket>` block with XMP metadata
        - `fx:` namespace for Factur-X: `urn:factur-x:pdfa:CrossIndustryDocument:invoice:1p0#`
        - Required Factur-X fields:
          - `fx:ConformanceLevel`: Profile (MINIMUM, BASIC, EN16931, EXTENDED)
          - `fx:DocumentFileName`: Embedded XML name
          - `fx:DocumentType`: "INVOICE"
          - `fx:Version`: Factur-X version (1.0.07)

        **What is verified:**
        - ‚úÖ Metadata conforming to ISO 16684-1
        - ‚úÖ Correct declared Factur-X profile
        - ‚úÖ Supported Factur-X version

        ### 4. Electronic signatures
        **Detection and analysis:**
        - Presence of `/Sig` dictionaries in PDF
        - Signature type: PAdES (PDF Advanced Electronic Signature)
        - Information extraction:
          - Signer name (`/Name`)
          - Signing date (`/M`)
          - Signature reason (`/Reason`)
          - Signature location (`/Location`)
          - Signature type (approval, certification)

        **What is verified:**
        - ‚úÖ Presence of signatures or seals
        - ‚úÖ Number of signatures (single or multi-signature)
        - ‚ÑπÔ∏è No cryptographic verification (requires certificates)

        ## Parameters

        - **pdf_file** (required): The Factur-X PDF file to validate
        - **profile** (optional): Expected profile. If absent, auto-detected from XML
        - **use_verapdf** (optional, default=false): Enable strict PDF/A validation with VeraPDF
          - `false`: Fast metadata validation (2-3 seconds)
          - `true`: Complete ISO 19005-3 validation (15-30 seconds, **recommended for production**)

        ## Detailed response

        ```json
        {
          "isCompliant": true,
          "xml": {
            "present": true,
            "compliant": true,
            "profile": "EN16931",
            "errors": []
          },
          "pdfa": {
            "compliant": true,
            "version": "PDF/A-3B",
            "method": "verapdf",
            "errors": []
          },
          "xmp": {
            "present": true,
            "compliant": true,
            "metadata": {...}
          },
          "signatures": {
            "present": true,
            "count": 1,
            "details": [...]
          }
        }
        ```

        ## Use cases

        - **Before sending**: Validate generated invoice before transmission to client
        - **On reception**: Verify compliance of invoice received from supplier
        - **Audit**: Check quality of invoice batches
        - **Legal compliance**: Ensure B2B/B2G obligations are met in France
        - **Debugging**: Identify issues in generation process
        - **Archiving**: Guarantee long-term validity (PDF/A-3)

        ## Processing time

        - Basic validation: 2-3 seconds
        - VeraPDF validation: 15-30 seconds (depends on PDF size)
      operationId: validate_facturx_pdf_api_v1_processing_validate_facturx_pdf_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_validate_facturx_pdf_api_v1_processing_validate_facturx_pdf_post"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PDFValidationResultAPI"
          description: Validation completed successfully (check is_compliant field
            for result)
        "400":
          description: Invalid or unreadable PDF file
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Validate a complete Factur-X PDF
      tags:
      - Invoice Processing
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/validate-facturx-async:
    post:
      description: |-
        Validates a Factur-X PDF asynchronously with polling system.

        ## How it works

        1. **Submission**: PDF is queued for asynchronous validation
        2. **Immediate return**: You receive a `task_id` (HTTP 202)
        3. **Tracking**: Use the `/tasks/{task_id}/status` endpoint to track progress

        ## Advantages of asynchronous mode

        - **No timeout**: Ideal for large PDFs or VeraPDF validation (which can take several seconds)
        - **Scalability**: Validations are processed by dedicated Celery workers
        - **Status tracking**: Allows you to monitor validation progress
        - **Non-blocking**: Your client doesn't wait during validation

        ## When to use this mode?

        - **VeraPDF validation enabled** (`use_verapdf=True`): Strict validation can take 2-10 seconds
        - **Large PDF files**: PDFs > 1 MB
        - **Batch processing**: Validating multiple invoices in parallel
        - **Asynchronous integration**: Your system supports polling

        ## Checks performed

        ### 1. Factur-X XML extraction and validation
        - Verifies presence of Factur-X compliant embedded XML file
        - Automatically detects profile used (MINIMUM, BASIC, EN16931, EXTENDED)
        - Validates XML against detected profile's Schematron rules

        ### 2. PDF/A compliance
        - **Without VeraPDF**: Basic metadata validation (fast, ~100ms)
        - **With VeraPDF**: Strict ISO 19005 validation (146+ rules, 2-10s)
          - Detects PDF/A version (PDF/A-1, PDF/A-3, etc.)
          - Detailed non-compliance reports

        ### 3. XMP metadata
        - Verifies presence of XMP metadata in PDF
        - Validates Factur-X metadata compliance (profile, version)
        - Extracts all available XMP metadata

        ### 4. Electronic signatures
        - Detects presence of electronic signatures or seals
        - Extracts information about each signature (signer, date, reason)
        - Counts number of signatures present

        ## Parameters

        - **pdf_file**: The Factur-X PDF file to validate
        - **profile**: Expected Factur-X profile (optional). If not specified, profile
          will be auto-detected from embedded XML file.
        - **use_verapdf**: Enable strict PDF/A validation with VeraPDF.
          ‚ö†Ô∏è **Warning**: VeraPDF can take 2-10 seconds depending on PDF size.
          Recommended only in asynchronous mode to avoid timeouts.

        ## Retrieving results

        After submission, use `GET /tasks/{task_id}/status` endpoint to retrieve the result.

        **Polling example**:
        ```python
        import requests
        import time

        # 1. Submit task
        response = requests.post("/validate-facturx-async", files={"pdf_file": pdf_file})
        task_id = response.json()["taskId"]

        # 2. Poll every 2 seconds
        while True:
            status_response = requests.get(f"/tasks/{task_id}/status")
            status = status_response.json()

            if status["status"] == "SUCCESS":
                result = status["result"]["validation_result"]
                print(f"Compliant: {result['is_compliant']}")
                break
            elif status["status"] == "FAILURE":
                print(f"Error: {status['result']['errorMessage']}")
                break

            time.sleep(2)  # Wait 2 seconds before next check
        ```

        ## Use cases

        - Validate invoices before sending with VeraPDF (strict validation)
        - Process invoice batches in parallel
        - Integrate validation into an asynchronous pipeline
        - Validate large PDFs without timeout risk
      operationId: validate_facturx_pdf_async_api_v1_processing_validate_facturx_async_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_validate_facturx_pdf_async_api_v1_processing_validate_facturx_async_post"
        required: true
      responses:
        "202":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
          description: Successful Response
        "400":
          description: Invalid or unreadable PDF file
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Validate a Factur-X PDF (asynchronous with polling)
      tags:
      - Invoice Processing
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/sign-pdf:
    post:
      description: |-
        Signs an uploaded PDF with the electronic certificate configured for the client (via client_uid from JWT).

            **Supported standards**: PAdES-B-B, PAdES-B-T (timestamping), PAdES-B-LT (long-term archiving).

            **eIDAS levels**: SES (self-signed), AdES (commercial CA), QES (PSCO - out of scope).

            **Security**: Double authentication X-Internal-Secret + JWT Bearer to retrieve the certificate.

            **‚ö†Ô∏è Legal disclaimer**: Generated signatures are electronic seals as defined by
            the eIDAS regulation. The level of legal validity depends on the certificate used (SES/AdES/QES).
            FactPulse does not provide QES qualified certificates - you must obtain a certificate from
            a PSCO (qualified Trust Service Provider) for maximum legal validity.
      operationId: sign_pdf_api_v1_processing_sign_pdf_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_sign_pdf_api_v1_processing_sign_pdf_post"
        required: true
      responses:
        "200":
          content:
            application/json:
              example:
                status: success
                signed_pdf_base64: JVBERi0xLjQKJeLjz9MKNSAwIG9iago8PC...
                filename: facture_signed.pdf
                size_bytes: 156789
                is_signed: true
                signer_cn: ACME Corporation - Server Seal
                signature_date: 2025-01-15T14:30:00+00:00
                certificate_expiration: 2026-12-31T23:59:59+00:00
              schema: {}
          description: PDF signed successfully
        "400":
          content:
            application/json:
              example:
                error: invalid_certificate
                message: Invalid or expired certificate
                help: Please update your certificate in your FactPulse dashboard
          description: Invalid or expired certificate
        "404":
          content:
            application/json:
              example:
                error: no_certificate
                message: No signing certificate configured for this client
                help: Please add a certificate in your FactPulse dashboard (Settings
                  > Signing Certificate)
                client_uid: 550e8400-e29b-41d4-a716-446655440000
          description: No certificate configured for this client
        "401":
          description: Not authenticated - Missing or invalid JWT token
        "503":
          description: Django service unavailable
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Sign a PDF with client's certificate (PAdES-B-LT)
      tags:
      - Invoice Processing
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/sign-pdf-async:
    post:
      description: |-
        Signs an uploaded PDF asynchronously via a Celery task.

            **Difference with /sign-pdf**:
            - `/sign-pdf`: Synchronous signature (blocking until completion)
            - `/sign-pdf-async`: Asynchronous signature (returns immediately with task_id)

            **Async advantages**:
            - No timeout for large files
            - No blocking of FastAPI worker
            - Progress tracking via task_id
            - Ideal for batch processing

            **Supported standards**: PAdES-B-B, PAdES-B-T (timestamping), PAdES-B-LT (long-term archiving).

            **‚ö†Ô∏è Legal disclaimer**: Same as /sign-pdf (see that endpoint's documentation).
      operationId: sign_pdf_async_api_v1_processing_sign_pdf_async_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_sign_pdf_async_api_v1_processing_sign_pdf_async_post"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "202":
          content:
            application/json:
              example:
                task_id: 550e8400-e29b-41d4-a716-446655440000
                status: PENDING
                message: Signature is being processed
          description: Signature task created successfully
        "400":
          description: Invalid parameters
        "401":
          description: Not authenticated - Missing or invalid JWT token
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Sign a PDF asynchronously (Celery)
      tags:
      - Invoice Processing
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/validate-pdf-signature:
    post:
      description: |-
        Validates electronic signatures present in an uploaded PDF.

            **Verifications performed**:
            - Presence of signatures
            - Document integrity (not modified since signing)
            - Certificate validity
            - Chain of trust (if available)
            - Presence of timestamp (PAdES-B-T)
            - Validation data (PAdES-B-LT)

            **Supported standards**: PAdES-B-B, PAdES-B-T, PAdES-B-LT, ISO 32000-2.

            **‚ö†Ô∏è Note**: This validation is technical (cryptographic integrity). Legal validity
            depends on the eIDAS level of the certificate (SES/AdES/QES) and the context of use.
      operationId: validate_pdf_signature_endpoint_api_v1_processing_validate_pdf_signature_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_validate_pdf_signature_endpoint_api_v1_processing_validate_pdf_signature_post"
        required: true
      responses:
        "200":
          content:
            application/json:
              example:
                is_signed: true
                signature_count: 1
                signatures:
                - field_name: FactPulseSignature
                  signer: ACME Corporation - Server Seal
                  signature_date: 2025-01-15T14:30:00+00:00
                  reason: Factur-X compliance
                  location: "Paris, France"
                  is_valid: true
                  pades_level: PAdES-B-LT
                  timestamped: true
                  validation_data: true
                errors: []
              schema: {}
          description: Validation successful
        "400":
          description: Invalid or unreadable file
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Validate electronic signatures of a PDF
      tags:
      - Invoice Processing
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/processing/generate-test-certificate:
    post:
      description: |-
        Generates a self-signed X.509 certificate for PDF electronic signature testing.

            **‚ö†Ô∏è WARNING: TEST certificate only!**

            This certificate is:
            - ‚úÖ Suitable for testing and development
            - ‚úÖ Compatible with PDF signing (PAdES)
            - ‚úÖ Compliant with eIDAS **SES** level (Simple Electronic Signature)
            - ‚ùå **NEVER usable in production**
            - ‚ùå **Not recognized** by browsers and PDF readers
            - ‚ùå **No legal value**

            ## eIDAS levels

            - **SES** (Simple): Self-signed certificate ‚Üê Generated by this endpoint
            - **AdES** (Advanced): Commercial CA certificate (Let's Encrypt, etc.)
            - **QES** (Qualified): Qualified certificate from QTSP (CertEurope, Universign, etc.)

            ## Usage

            Once generated, the certificate can be:

            1. **Saved in Django** (recommended):
               - Django Admin > Signing Certificates
               - Upload `certificate_pem` and `private_key_pem`

            2. **Used directly**:
               - Sign a PDF with `/sign-pdf`
               - The certificate will be automatically used

            ## Example call

            ```bash
            curl -X POST "https://www.factpulse.fr/api/v1/processing/generate-test-certificate" \
              -H "Authorization: Bearer eyJ0eXAi..." \
              -H "Content-Type: application/json" \
              -d '{
                "cn": "Test Client XYZ",
                "organization": "Client XYZ Ltd",
                "email": "contact@xyz.com",
                "validity_days": 365
              }'
            ```

            ## Use cases

            - PDF signature testing in development
            - Electronic signature POC
            - Training and demos
            - Automated integration tests

            ## Technical compliance

            Certificate generated with:
            - RSA key 2048 or 4096 bits
            - SHA-256 algorithm
            - Key Usage extensions: `digitalSignature`, `contentCommitment` (non-repudiation)
            - Extended Key Usage extensions: `codeSigning`, `emailProtection`
            - Validity: 1 day to 10 years (configurable)
            - Format: PEM (certificate and key)
            - Optional: PKCS#12 (.p12)
      operationId: generate_test_certificate_api_v1_processing_generate_test_certificate_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenerateCertificateRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerateCertificateResponse"
          description: Certificate generated successfully
        "400":
          content:
            application/json:
              example:
                detail: Key size must be 2048 or 4096
          description: Invalid request (incorrect parameters)
        "500":
          content:
            application/json:
              example:
                detail: "Error generating certificate: ..."
          description: Server error during generation
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Generate a self-signed X.509 test certificate
      tags:
      - Invoice Processing
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/processing/invoices/submit-complete:
    post:
      description: |-
        Unified endpoint to submit a complete invoice to different destinations.

            **Automated workflow:**
            1. **Auto-enrichment** (optional): retrieves data via public APIs and Chorus Pro/AFNOR
            2. **Factur-X PDF generation**: creates a PDF/A-3 with embedded XML
            3. **Electronic signature** (optional): signs the PDF with a certificate
            4. **Submission**: sends to the chosen destination (Chorus Pro or AFNOR PDP)

            **Supported destinations:**
            - **Chorus Pro**: French B2G platform (invoices to public sector)
            - **AFNOR PDP**: Partner Dematerialization Platforms

            **Destination credentials - 2 modes available:**

            **Mode 1 - Retrieval via JWT (recommended):**
            - Credentials are retrieved automatically via the JWT `client_uid`
            - Do not provide the `credentials` field in `destination`
            - Zero-trust architecture: no secrets in the payload
            - Example: `"destination": {"type": "chorus_pro"}`

            **Mode 2 - Credentials in the payload:**
            - Provide credentials directly in the payload
            - Useful for tests or third-party integrations
            - Example: `"destination": {"type": "chorus_pro", "credentials": {...}}`


            **Electronic signature (optional) - 2 modes available:**

            **Mode 1 - Stored certificate (recommended):**
            - Certificate is retrieved automatically via the JWT `client_uid`
            - No key to provide in the payload
            - PAdES-B-LT signature with timestamp (eIDAS compliant)
            - Example: `"signature": {"reason": "Factur-X compliance"}`

            **Mode 2 - Keys in the payload (for tests):**
            - Provide `key_pem` and `cert_pem` directly
            - PEM format accepted: raw or base64
            - Useful for tests or special cases without stored certificate
            - Example: `"signature": {"key_pem": "-----BEGIN...", "cert_pem": "-----BEGIN..."}`

            If `key_pem` and `cert_pem` are provided ‚Üí Mode 2
            Otherwise ‚Üí Mode 1 (certificate retrieved via `client_uid`)
      operationId: submit_complete_invoice_api_v1_processing_invoices_submit_complete_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitCompleteInvoiceRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SubmitCompleteInvoiceResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Submit a complete invoice (generation + signature + submission)
      tags:
      - Invoice Processing
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/processing/invoices/submit-complete-async:
    post:
      description: |-
        Asynchronous version of the `/invoices/submit-complete` endpoint using Celery for background processing.

            **Automated workflow (same as synchronous version):**
            1. **Auto-enrichment** (optional): retrieves data via public APIs and Chorus Pro/AFNOR
            2. **Factur-X PDF generation**: creates a PDF/A-3 with embedded XML
            3. **Electronic signature** (optional): signs the PDF with a certificate
            4. **Submission**: sends to the chosen destination (Chorus Pro or AFNOR PDP)

            **Supported destinations:**
            - **Chorus Pro**: French B2G platform (invoices to public sector)
            - **AFNOR PDP**: Partner Dematerialization Platforms

            **Differences with synchronous version:**
            - ‚úÖ **Non-blocking**: Returns immediately with a `task_id` (HTTP 202 Accepted)
            - ‚úÖ **Background processing**: Invoice is processed by a Celery worker
            - ‚úÖ **Progress tracking**: Use `/tasks/{task_id}/status` to track status
            - ‚úÖ **Ideal for high volumes**: Allows processing many invoices in parallel

            **How to use:**
            1. **Submission**: Call this endpoint with your invoice data
            2. **Immediate return**: You receive a `task_id` (e.g., "abc123-def456")
            3. **Tracking**: Call `/tasks/{task_id}/status` to check progress
            4. **Result**: When `status = "SUCCESS"`, the `result` field contains the complete response

            **Credentials and signature**: Same modes as the synchronous version (JWT or payload).
      operationId: submit_complete_invoice_async_api_v1_processing_invoices_submit_complete_async_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitCompleteInvoiceRequest"
        required: true
      responses:
        "202":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Submit a complete invoice (asynchronous with Celery)
      tags:
      - Invoice Processing
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/afnor/credentials:
    get:
      description: Retrieves stored AFNOR/PDP credentials for the JWT's client_uid.
        This endpoint is used by the SDK in 'stored' mode to retrieve credentials
        before performing AFNOR OAuth itself.
      operationId: get_afnor_credentials_api_v1_afnor_credentials_get
      responses:
        "200":
          content:
            application/json:
              example:
                flow_service_url: https://api.pdp-partner.fr/flow/v1
                token_url: https://auth.pdp-partner.fr/oauth/token
                client_id: factpulse_client
                client_secret: '***'
              schema: {}
          description: AFNOR credentials retrieved successfully
        "400":
          content:
            application/json:
              example:
                detail:
                  error: NO_CLIENT_UID
                  message: No client_uid in JWT. Use zero-trust mode.
          description: No client_uid in JWT
        "401":
          description: Not authenticated - Missing or invalid JWT token
        "404":
          description: Client not found or no AFNOR credentials configured
      security:
      - HTTPBearer: []
      summary: Retrieve stored AFNOR credentials
      tags:
      - AFNOR PDP/PA
      x-accepts:
      - application/json
  /api/v1/afnor/oauth/token:
    post:
      description: OAuth2 proxy endpoint to obtain an AFNOR access token. Proxies
        to AFNOR mock (sandbox) or real PDP depending on MOCK_AFNOR_BASE_URL. This
        endpoint is public (no Django auth required) as it is called by the AFNOR
        SDK.
      operationId: oauth_token_proxy_api_v1_afnor_oauth_token_post
      responses:
        "200":
          content:
            application/json:
              example:
                access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                token_type: Bearer
                expires_in: 3600
              schema: {}
          description: OAuth2 token acquired successfully
        "401":
          description: Invalid credentials
      summary: OAuth2 endpoint for AFNOR authentication
      tags:
      - AFNOR PDP/PA
      x-accepts:
      - application/json
  /api/v1/afnor/incoming-flows/{flow_id}:
    get:
      description: "Downloads an incoming flow from the AFNOR PDP and extracts invoice\
        \ metadata into a unified JSON format. Supports Factur-X, CII, and UBL formats."
      operationId: get_flux_entrant_api_v1_afnor_incoming_flows__flow_id__get
      parameters:
      - explode: false
        in: path
        name: flow_id
        required: true
        schema:
          title: Flow Id
          type: string
        style: simple
      - explode: true
        in: query
        name: include_document
        required: false
        schema:
          default: false
          title: Include Document
          type: boolean
        style: form
      responses:
        "200":
          content:
            application/json:
              example:
                flowId: 550e8400-e29b-41d4-a716-446655440000
                sourceFormat: Factur-X
                supplierReference: FAC-2025-001
                documentType: "380"
                supplier:
                  name: Supplier SAS
                  siret: "12345678901234"
                  vatNumber: FR12345678901
                billingSiteName: My Company
                billingSiteSiret: "98765432109876"
                issueDate: 2025-01-15
                dueDate: 2025-02-15
                currency: EUR
                netAmount: "1000.00"
                vatAmount: "200.00"
                grossAmount: "1200.00"
              schema:
                $ref: "#/components/schemas/IncomingInvoice"
          description: Invoice extracted successfully
        "400":
          description: Unsupported or invalid invoice format
        "401":
          description: Not authenticated
        "404":
          description: Flow not found
        "503":
          description: PDP service unavailable
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Retrieve and extract an incoming invoice
      tags:
      - AFNOR PDP/PA
      x-accepts:
      - application/json
  /api/v1/afnor/flow/v1/healthcheck:
    get:
      description: Check Flow Service availability
      operationId: flow_healthcheck_proxy_api_v1_afnor_flow_v1_healthcheck_get
      responses:
        "200":
          content:
            application/json:
              example:
                status: ok
                service: Flow Service
              schema: {}
          description: Service operational
      summary: Healthcheck Flow Service
      tags:
      - AFNOR PDP/PA - Flow Service
      x-accepts:
      - application/json
  /api/v1/afnor/flow/v1/flows:
    post:
      description: Submits an electronic invoice to a Partner Dematerialization Platform
        (PDP) in compliance with the AFNOR XP Z12-013 standard
      operationId: submit_flow_proxy_api_v1_afnor_flow_v1_flows_post
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "201":
          content:
            application/json:
              example:
                flowId: 550e8400-e29b-41d4-a716-446655440000
                trackingId: FAC-2025-001
                status: submitted
                sha256: a3d2c1b4e5f6789...
                name: Invoice FAC-2025-001
                flowSyntax: CII
                flowProfile: EN16931
          description: Flow submitted successfully
        "400":
          content:
            application/json:
              examples:
                no_pdp_config:
                  summary: No PDP configuration provided
                  value:
                    detail:
                      error: no_pdp_config
                      message: No PDP configuration provided
                      help: |-
                        You must either:
                        1. Have a client_uid in your JWT (strategy A)
                        2. Provide pdp_credentials in the request (strategy B)
                invalid_pdf:
                  summary: Invalid PDF file
                  value:
                    detail: The file is not a valid PDF/A-3
          description: Invalid request or missing PDP configuration
        "401":
          description: Not authenticated - Missing or invalid JWT token
        "403":
          description: Not authorized - Quota exceeded or insufficient permissions
        "404":
          content:
            application/json:
              example:
                detail:
                  error: client_not_found
                  message: Client 550e8400-e29b-41d4-a716-446655440000 does not exist
                  client_uid: 550e8400-e29b-41d4-a716-446655440000
          description: PDP client not found (invalid client_uid)
        "429":
          description: Too many requests - Rate limit reached (30 submissions/minute)
      summary: Submit an invoicing flow
      tags:
      - AFNOR PDP/PA - Flow Service
      x-accepts:
      - application/json
  /api/v1/afnor/flow/v1/flows/search:
    post:
      description: Search invoicing flows by criteria (uses JWT client_uid)
      operationId: search_flows_proxy_api_v1_afnor_flow_v1_flows_search_post
      responses:
        "200":
          content:
            application/json:
              example:
                flows:
                - flowId: 550e8400-e29b-41d4-a716-446655440000
                  trackingId: FAC-2025-001
                  status: submitted
                  submittedAt: 2025-01-05T10:00:00Z
                total: 1
                offset: 0
                limit: 10
              schema: {}
          description: Search results
        "400":
          content:
            application/json:
              example:
                detail:
                  error: no_pdp_config
                  message: No PDP configuration provided
                  help: Add a client_uid to your JWT
          description: Missing PDP configuration
        "401":
          description: Not authenticated - Missing or invalid JWT token
        "404":
          description: PDP client not found (invalid client_uid)
        "429":
          description: Too many requests - Rate limit reached (60 searches/minute)
      summary: Search flows
      tags:
      - AFNOR PDP/PA - Flow Service
      x-accepts:
      - application/json
  /api/v1/afnor/flow/v1/flows/{flowId}:
    get:
      description: Download the PDF/A-3 file of an invoicing flow (uses JWT client_uid)
      operationId: download_flow_proxy_api_v1_afnor_flow_v1_flows__flowId__get
      parameters:
      - explode: false
        in: path
        name: flowId
        required: true
        schema:
          title: Flowid
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema: {}
            application/pdf:
              schema:
                format: binary
                type: string
          description: PDF/A-3 file
        "400":
          content:
            application/json:
              example:
                detail:
                  error: no_pdp_config
                  message: No PDP configuration provided
          description: Missing PDP configuration
        "401":
          description: Not authenticated - Missing or invalid JWT token
        "404":
          content:
            application/json:
              examples:
                flow_not_found:
                  summary: Flow does not exist
                  value:
                    detail: Flow 550e8400-... not found
                client_not_found:
                  summary: Invalid PDP client
                  value:
                    detail:
                      error: client_not_found
                      message: Client 550e8400-... does not exist
          description: Flow not found or invalid client_uid
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Download a flow
      tags:
      - AFNOR PDP/PA - Flow Service
      x-accepts:
      - application/json
      - application/pdf
  /api/v1/afnor/directory/v1/healthcheck:
    get:
      description: Check Directory Service availability
      operationId: directory_healthcheck_proxy_api_v1_afnor_directory_v1_healthcheck_get
      responses:
        "200":
          content:
            application/json:
              example:
                status: ok
                service: Directory Service
              schema: {}
          description: Service operational
      summary: Healthcheck Directory Service
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/siren/search:
    post:
      description: Multi-criteria search for companies (legal units)
      operationId: search_siren_proxy_api_v1_afnor_directory_v1_siren_search_post
      responses:
        "200":
          content:
            application/json:
              example:
                data:
                - siren: "123456789"
                  businessName: ACME Corporation
                  entityType: PM
                  administrativeStatus: A
                meta:
                  total: 1
                  offset: 0
                  limit: 10
              schema: {}
          description: Returns one or more companies
        "401":
          description: Not authenticated
      security:
      - HTTPBearer: []
      summary: SIREN search (or legal unit)
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/siren/code-insee:{siren}:
    get:
      description: Returns details of a company (legal unit) identified by its SIREN
        number
      operationId: get_siren_by_code_insee_proxy_api_v1_afnor_directory_v1_siren_code_insee__siren__get
      parameters:
      - explode: false
        in: path
        name: siren
        required: true
        schema:
          title: Siren
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                siren: "123456789"
                businessName: ACME Corporation
                entityType: PM
                administrativeStatus: A
              schema: {}
          description: Company information
        "404":
          description: Company not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Consult a siren (legal unit) by SIREN number
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/siren/id-instance:{id_instance}:
    get:
      description: Get a company (legal unit) identified by its idInstance
      operationId: get_siren_by_id_instance_proxy_api_v1_afnor_directory_v1_siren_id_instance__id_instance__get
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                siren: "123456789"
                businessName: ACME Corporation
                idInstance: 550e8400-e29b-41d4-a716-446655440000
              schema: {}
          description: Company information
        "404":
          description: Company not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Gets a siren (legal unit) by instance ID
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/siret/search:
    post:
      description: Multi-criteria search for establishments
      operationId: search_siret_proxy_api_v1_afnor_directory_v1_siret_search_post
      responses:
        "200":
          content:
            application/json:
              example:
                data:
                - siret: "12345678901234"
                  siren: "123456789"
                  name: ACME Corporation - Headquarters
                  facilityType: SIEGE
                meta:
                  total: 1
                  offset: 0
                  limit: 10
              schema: {}
          description: Returns one or more establishments
        "401":
          description: Not authenticated
      security:
      - HTTPBearer: []
      summary: Search for a SIRET (facility)
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/siret/code-insee:{siret}:
    get:
      description: Get an establishment identified by its SIRET number
      operationId: get_siret_by_code_insee_proxy_api_v1_afnor_directory_v1_siret_code_insee__siret__get
      parameters:
      - explode: false
        in: path
        name: siret
        required: true
        schema:
          title: Siret
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                siret: "12345678901234"
                siren: "123456789"
                name: ACME Corporation - Headquarters
                facilityType: SIEGE
              schema: {}
          description: Establishment information
        "404":
          description: Establishment not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Gets a siret (facility) by SIRET number
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/siret/id-instance:{id_instance}:
    get:
      description: Get an establishment identified by its idInstance
      operationId: get_siret_by_id_instance_proxy_api_v1_afnor_directory_v1_siret_id_instance__id_instance__get
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                siret: "12345678901234"
                siren: "123456789"
                idInstance: 550e8400-e29b-41d4-a716-446655440000
              schema: {}
          description: Establishment information
        "404":
          description: Establishment not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Gets a siret (facility) by id-instance
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/routing-code:
    post:
      description: Create a routing code in the directory
      operationId: create_routing_code_proxy_api_v1_afnor_directory_v1_routing_code_post
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "201":
          description: Routing code created successfully
        "400":
          description: Invalid request
        "401":
          description: Not authenticated
      security:
      - HTTPBearer: []
      summary: Create a routing code
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/routing-code/search:
    post:
      description: Search for routing codes by criteria
      operationId: search_routing_code_proxy_api_v1_afnor_directory_v1_routing_code_search_post
      responses:
        "200":
          content:
            application/json:
              example:
                data:
                - siret: "12345678901234"
                  routingIdentifier: SERVICE01
                  idInstance: 550e8400-e29b-41d4-a716-446655440000
                meta:
                  total: 1
                  offset: 0
                  limit: 10
              schema: {}
          description: Search results
        "401":
          description: Not authenticated
      security:
      - HTTPBearer: []
      summary: Search for a routing code
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/routing-code/siret:{siret}/code:{routing_identifier}:
    get:
      description: Consult a routing code identified by SIRET and routing identifier
      operationId: get_routing_code_by_siret_and_code_proxy_api_v1_afnor_directory_v1_routing_code_siret__siret__code__routing_identifier__get
      parameters:
      - explode: false
        in: path
        name: siret
        required: true
        schema:
          title: Siret
          type: string
        style: simple
      - explode: false
        in: path
        name: routing_identifier
        required: true
        schema:
          title: Routing Identifier
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                siret: "12345678901234"
                routingIdentifier: SERVICE01
                idInstance: 550e8400-e29b-41d4-a716-446655440000
              schema: {}
          description: Routing code details
        "404":
          description: Routing code not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Get a routing code by SIRET and routing identifier
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/routing-code/id-instance:{id_instance}:
    get:
      description: Get a routing code identified by its idInstance
      operationId: get_routing_code_by_id_instance_proxy_api_v1_afnor_directory_v1_routing_code_id_instance__id_instance__get
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                siret: "12345678901234"
                routingIdentifier: SERVICE01
                idInstance: 550e8400-e29b-41d4-a716-446655440000
              schema: {}
          description: Routing code details
        "404":
          description: Routing code not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Get a routing code by instance-id
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
    patch:
      description: Partially update a private routing code
      operationId: patch_routing_code_proxy_api_v1_afnor_directory_v1_routing_code_id_instance__id_instance__patch
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Routing code updated
        "404":
          description: Routing code not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Partially update a private routing code
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
    put:
      description: Completely update a private routing code
      operationId: put_routing_code_proxy_api_v1_afnor_directory_v1_routing_code_id_instance__id_instance__put
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Routing code updated
        "404":
          description: Routing code not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Completely update a private routing code
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/directory-line:
    post:
      description: Create a line in the directory
      operationId: create_directory_line_proxy_api_v1_afnor_directory_v1_directory_line_post
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "201":
          description: Directory line created successfully
        "400":
          description: Invalid request
        "401":
          description: Not authenticated
      security:
      - HTTPBearer: []
      summary: Creating a directory line
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/directory-line/search:
    post:
      description: Search for directory lines by criteria
      operationId: search_directory_line_proxy_api_v1_afnor_directory_v1_directory_line_search_post
      responses:
        "200":
          content:
            application/json:
              example:
                data:
                - addressingIdentifier: 123456789_12345678901234_SERVICE01
                  siren: "123456789"
                  siret: "12345678901234"
                  routingIdentifier: SERVICE01
                meta:
                  total: 1
                  offset: 0
                  limit: 10
              schema: {}
          description: Search results
        "401":
          description: Not authenticated
      security:
      - HTTPBearer: []
      summary: Search for a directory line
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/directory-line/code:{addressing_identifier}:
    get:
      description: Get a directory line identified by an addressing identifier
      operationId: get_directory_line_by_code_proxy_api_v1_afnor_directory_v1_directory_line_code__addressing_identifier__get
      parameters:
      - explode: false
        in: path
        name: addressing_identifier
        required: true
        schema:
          title: Addressing Identifier
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                addressingIdentifier: 123456789_12345678901234_SERVICE01
                siren: "123456789"
                siret: "12345678901234"
                routingIdentifier: SERVICE01
              schema: {}
          description: Directory line details
        "404":
          description: Directory line not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Get a directory line
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/afnor/directory/v1/directory-line/id-instance:{id_instance}:
    delete:
      description: Delete a directory line
      operationId: delete_directory_line_proxy_api_v1_afnor_directory_v1_directory_line_id_instance__id_instance__delete
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "204":
          description: Directory line deleted
        "404":
          description: Directory line not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Delete a directory line
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
    get:
      description: Get a directory line identified by its idInstance
      operationId: get_directory_line_by_id_instance_proxy_api_v1_afnor_directory_v1_directory_line_id_instance__id_instance__get
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                addressingIdentifier: 123456789_12345678901234_SERVICE01
                siren: "123456789"
                siret: "12345678901234"
                idInstance: 550e8400-e29b-41d4-a716-446655440000
              schema: {}
          description: Directory line details
        "404":
          description: Directory line not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Get a directory line
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
    patch:
      description: Partially update a directory line
      operationId: patch_directory_line_proxy_api_v1_afnor_directory_v1_directory_line_id_instance__id_instance__patch
      parameters:
      - explode: false
        in: path
        name: id_instance
        required: true
        schema:
          title: Id Instance
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Directory line updated
        "404":
          description: Directory line not found
        "401":
          description: Not authenticated
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Partially updates a directory line
      tags:
      - AFNOR PDP/PA - Directory Service
      x-accepts:
      - application/json
  /api/v1/chorus-pro/structures/rechercher:
    post:
      description: |-
        Search for structures (companies, administrations) registered on Chorus Pro.

            **Use cases**:
            - Find the Chorus Pro ID of a structure from its SIRET
            - Check if a structure is registered on Chorus Pro
            - List structures matching criteria

            **Available filters**:
            - Identifier (SIRET, SIREN, etc.)
            - Company name
            - Identifier type
            - Private structures only

            **Typical step**: Called before `submit-invoice` to get the recipient's `id_structure_cpp`.
      operationId: rechercher_structures_api_v1_chorus_pro_structures_rechercher_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchStructureRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchStructureResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Search Chorus Pro structures
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/structures/consulter:
    post:
      description: |-
        Retrieves detailed information about a Chorus Pro structure.


            **Returns**:
            - Company name
            - Intra-EU VAT number
            - Contact email
            - **Required parameters**: Indicates if service code and/or engagement number are required to submit an invoice

            **Typical step**: Called after `search-structures` to know which fields are mandatory before submitting an invoice.
      operationId: consulter_structure_api_v1_chorus_pro_structures_consulter_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetStructureRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetStructureResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Consult structure details
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/structures/{id_structure_cpp}/services:
    get:
      description: |-
        Retrieves the list of active services for a public structure.

            **Use cases**:
            - List available services for an administration
            - Verify that a service code exists before submitting an invoice

            **Returns**:
            - List of services with their code, label, and status (active/inactive)
      operationId: lister_services_structure_api_v1_chorus_pro_structures__id_structure_cpp__services_get
      parameters:
      - explode: false
        in: path
        name: id_structure_cpp
        required: true
        schema:
          title: Id Structure Cpp
          type: integer
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchServicesResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: List structure services
      tags:
      - Chorus Pro
      x-accepts:
      - application/json
  /api/v1/chorus-pro/structures/obtenir-id-depuis-siret:
    post:
      description: |-
        **Convenient utility** to get a structure's Chorus Pro ID from its SIRET.


            This wrapper function combines:
            1. Searching for the structure by SIRET
            2. Extracting the `id_structure_cpp` if a single structure is found

            **Returns**:
            - `id_structure_cpp`: Chorus Pro ID (0 if not found or multiple results)
            - `designation_structure`: Structure name (if found)
            - `message`: Explanatory message

            **Use cases**:
            - Shortcut to directly get the Chorus Pro ID before submitting an invoice
            - Simplified alternative to `search-structures` + manual ID extraction

            **Note**: If multiple structures match the SIRET (rare), returns 0 and an error message.
      operationId: obtenir_id_chorus_pro_depuis_siret_api_v1_chorus_pro_structures_obtenir_id_depuis_siret_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetChorusProIdRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetChorusProIdResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: "Utility: Get Chorus Pro ID from SIRET"
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/soumettre:
    post:
      description: |-
        Submits an electronic invoice to a public structure via Chorus Pro.


            **Complete workflow**:
            1. **Upload the Factur-X PDF** via `/transverses/ajouter-fichier` ‚Üí retrieve `pieceJointeId`
            2. **Get the structure ID** via `/structures/rechercher` or `/structures/obtenir-id-depuis-siret`
            3. **Check mandatory parameters** via `/structures/consulter`
            4. **Submit the invoice** with the `piece_jointe_principale_id` obtained in step 1

            **Prerequisites**:
            1. Have the recipient's `id_structure_cpp` (via `/structures/rechercher`)
            2. Know the mandatory parameters (via `/structures/consulter`):
               - Service code if `code_service_doit_etre_renseigne=true`
               - Engagement number if `numero_ej_doit_etre_renseigne=true`
            3. Have uploaded the Factur-X PDF (via `/transverses/ajouter-fichier`)

            **Expected format**:
            - `piece_jointe_principale_id`: ID returned by `/transverses/ajouter-fichier`
            - Amounts: Strings with 2 decimals (e.g., "1250.50")
            - Dates: ISO 8601 format (YYYY-MM-DD)

            **Returns**:
            - `identifiant_facture_cpp`: Chorus Pro ID of the created invoice
            - `numero_flux_depot`: Deposit tracking number

            **Possible statuses after submission**:
            - SOUMISE: Pending validation
            - VALIDEE: Validated by recipient
            - REJETEE: Rejected (data error or business refusal)
            - SUSPENDUE: Pending additional information

            **Note**: Use `/factures/consulter` to track status changes.
      operationId: soumettre_facture_api_v1_chorus_pro_factures_soumettre_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitInvoiceRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SubmitInvoiceResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Submit an invoice to Chorus Pro
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/consulter:
    post:
      description: |-
        Retrieves the information and current status of an invoice submitted to Chorus Pro.

            **Returns**:
            - Invoice number and date
            - Total gross amount
            - **Current status**: SOUMISE, VALIDEE, REJETEE, SUSPENDUE, MANDATEE, MISE_EN_PAIEMENT, etc.
            - Recipient structure

            **Use cases**:
            - Track the processing progress of an invoice
            - Check if an invoice has been validated or rejected
            - Get the payment date

            **Polling**: Call this endpoint regularly to track status changes.
      operationId: consulter_facture_api_v1_chorus_pro_factures_consulter_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetInvoiceRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetInvoiceResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Consult invoice status
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/rechercher-fournisseur:
    post:
      description: |-
        Search invoices issued by the connected supplier.

            **Available filters**:
            - Invoice number
            - Dates (start/end)
            - Status
            - Recipient structure
            - Amount

            **Use cases**:
            - Track issued invoices
            - Verify statuses
            - Export for accounting
      operationId: rechercher_factures_fournisseur_api_v1_chorus_pro_factures_rechercher_fournisseur_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: {}
              title: Payload
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Search issued invoices (Supplier)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/rechercher-destinataire:
    post:
      description: |-
        Search invoices received by the connected recipient.

            **Filters**:
            - Downloaded / not downloaded
            - Reception dates
            - Status (MISE_A_DISPOSITION, SUSPENDUE, etc.)
            - Supplier

            **Useful indicator**: `factureTelechargeeParDestinataire` indicates whether the invoice has already been downloaded.
      operationId: rechercher_factures_destinataire_api_v1_chorus_pro_factures_rechercher_destinataire_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Search received invoices (Recipient)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/telecharger-groupe:
    post:
      description: |-
        Download one or more invoices (max 10 recommended) with their attachments.

            **Available formats**:
            - PDF: PDF file only
            - XML: XML file only
            - ZIP: Archive containing PDF + XML + attachments

            **Maximum size**: 120 MB per download

            **Example payload**:
            ```json
            {
              "listeIdentifiantsFactureCPP": [12345, 12346],
              "inclurePiecesJointes": true,
              "formatFichier": "ZIP"
            }
            ```

            **Returns**: The file is base64-encoded in the `fichierBase64` field.

            **Note**: The `factureTelechargeeParDestinataire` flag is automatically updated.
      operationId: telecharger_groupe_factures_api_v1_chorus_pro_factures_telecharger_groupe_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Download a group of invoices
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/traiter-facture-recue:
    post:
      description: |-
        Change the status of a received invoice.

            **Possible statuses**:
            - MISE_A_DISPOSITION: Invoice accepted
            - SUSPENDUE: Pending additional information (reason required)
            - REJETEE: Invoice refused (reason required)
            - MANDATEE: Invoice mandated
            - MISE_EN_PAIEMENT: Invoice being paid
            - COMPTABILISEE: Invoice accounted
            - MISE_A_DISPOSITION_COMPTABLE: Made available to accounting
            - A_RECYCLER: To be recycled
            - COMPLETEE: Completed
            - SERVICE-FAIT: Service rendered
            - PRISE_EN_COMPTE_DESTINATAIRE: Acknowledged
            - TRANSMISE_MOA: Transmitted to MOA

            **Example payload**:
            ```json
            {
              "identifiantFactureCPP": 12345,
              "nouveauStatut": "REJETEE",
              "motifRejet": "Duplicate invoice",
              "commentaire": "Invoice already received under reference ABC123"
            }
            ```

            **Rules**:
            - A reason is **required** for SUSPENDUE and REJETEE
            - Only certain statuses are allowed depending on the invoice's current status
      operationId: traiter_facture_recue_api_v1_chorus_pro_factures_traiter_facture_recue_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Process a received invoice (Recipient)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/recycler:
    post:
      description: |-
        Recycle an invoice with A_RECYCLER status by modifying routing data.

            **Required status**: A_RECYCLER

            **Modifiable fields**:
            - Recipient (`idStructureCPP`)
            - Service code
            - Engagement number

            **Use cases**:
            - Wrong recipient
            - Change of billing service
            - Update engagement number

            **Example payload**:
            ```json
            {
              "identifiantFactureCPP": 12345,
              "idStructureCPP": 67890,
              "codeService": "SERVICE_01",
              "numeroEngagement": "ENG2024001"
            }
            ```

            **Note**: The invoice keeps its number and amounts, only routing fields change.
      operationId: recycler_facture_api_v1_chorus_pro_factures_recycler_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Recycle an invoice (Supplier)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/completer:
    post:
      description: |-
        Complete a SUSPENDUE status invoice by adding attachments or a comment.

            **Required status**: SUSPENDUE

            **Possible actions**:
            - Add attachments (supporting documents, purchase orders, etc.)
            - Modify comment

            **Example payload**:
            ```json
            {
              "identifiantFactureCPP": 12345,
              "commentaire": "Here are the requested documents",
              "listePiecesJointes": [
                {
                  "pieceJointeIdFichier": 98765,
                  "pieceJointeNom": "purchase_order.pdf"
                }
              ]
            }
            ```

            **Note**: Attachments must first be uploaded via `/transverses/ajouter-fichier`.

            **After completion**: The invoice returns to MISE_A_DISPOSITION status.
      operationId: completer_facture_api_v1_chorus_pro_factures_completer_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Complete a suspended invoice (Supplier)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/valideur/rechercher:
    post:
      description: |-
        Search invoices pending validation by the connected validator.

            **Role**: Validator in the internal validation workflow.

            **Filters**: Dates, structure, service, etc.
      operationId: valideur_rechercher_factures_api_v1_chorus_pro_factures_valideur_rechercher_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Search invoices to validate (Validator)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/valideur/consulter:
    post:
      operationId: valideur_consulter_facture_api_v1_chorus_pro_factures_valideur_consulter_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Consult an invoice (Validator)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/factures/valideur/traiter:
    post:
      description: |-
        Validate or reject an invoice pending validation.

            **Actions**:
            - Validate: The invoice moves to the next status in the workflow
            - Reject: The invoice is rejected (reason required)
      operationId: valideur_traiter_facture_api_v1_chorus_pro_factures_valideur_traiter_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Validate or reject an invoice (Validator)
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/chorus-pro/transverses/ajouter-fichier:
    post:
      description: |-
        Add an attachment to the current user account.

            **Max size**: 10 MB per file

            **Example payload**:
            ```json
            {
              "pieceJointeFichier": "JVBERi0xLjQKJeLjz9MKNSAwIG9iago8P...",
              "pieceJointeNom": "purchase_order.pdf",
              "pieceJointeTypeMime": "application/pdf",
              "pieceJointeExtension": "PDF"
            }
            ```

            **Returns**: The attachment ID (`pieceJointeIdFichier`) to use in `/factures/completer`.

            **Accepted extensions**: PDF, JPG, PNG, ZIP, XML, etc.
      operationId: ajouter_fichier_api_v1_chorus_pro_transverses_ajouter_fichier_post
      requestBody:
        content:
          application/json:
            schema:
              additionalProperties: true
              title: Payload
              type: object
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Add an attachment
      tags:
      - Chorus Pro
      x-content-type: application/json
      x-accepts:
      - application/json
  /api/v1/verification/verify:
    post:
      description: |-
        Verifies compliance between the PDF and its embedded Factur-X XML.

        **IMPORTANT**: Only Factur-X PDFs (with embedded XML) are accepted.
        PDFs without Factur-X XML will be rejected with a 400 error.

        This synchronous version uses only native PDF extraction (pdfplumber).
        For image PDFs requiring OCR, use the `/verify-async` endpoint.

        **Verification principle (Factur-X 1.08):**
        - Principle #2: XML can only contain info present in the PDF
        - Principle #4: All XML info must be present and compliant in the PDF

        **Verified fields:**
        - Identification: BT-1 (invoice #), BT-2 (date), BT-3 (type), BT-5 (currency), BT-23 (framework)
        - Seller: BT-27 (name), BT-29 (SIRET), BT-30 (SIREN), BT-31 (VAT)
        - Buyer: BT-44 (name), BT-46 (SIRET), BT-47 (SIREN), BT-48 (VAT)
        - Amounts: BT-109 (excl. tax), BT-110 (VAT), BT-112 (incl. tax), BT-115 (amount due)
        - VAT breakdown: BT-116, BT-117, BT-118, BT-119
        - Invoice lines: BT-153, BT-129, BT-146, BT-131
        - Mandatory notes: PMT, PMD, AAB
        - Rule BR-FR-09: SIRET/SIREN consistency
      operationId: verify_pdf_sync_api_v1_verification_verify_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_verify_pdf_sync_api_v1_verification_verify_post"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerificationSuccessResponse"
          description: Verification successful
        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
          description: "Verification error (non Factur-X PDF, invalid, etc.)"
        "413":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
          description: PDF too large or too many pages
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Verify PDF/XML Factur-X compliance (synchronous)
      tags:
      - PDF/XML Verification
      - PDF/XML Verification
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/verification/verify-async:
    post:
      description: |-
        Verifies PDF/XML Factur-X compliance asynchronously.

        **IMPORTANT**: Only Factur-X PDFs (with embedded XML) are accepted.
        PDFs without Factur-X XML will return a `NOT_FACTURX` error in the result.

        This version uses a Celery task and can call the OCR service
        if the PDF is an image or if `force_ocr=true`.

        **Returns immediately** a task ID. Use `/verify-async/{task_id}/status`
        to retrieve the result.

        **Verification principle (Factur-X 1.08):**
        - Principle #2: XML can only contain info present in the PDF
        - Principle #4: All XML info must be present and compliant in the PDF

        **Verified fields:**
        - Identification: BT-1 (invoice #), BT-2 (date), BT-3 (type), BT-5 (currency), BT-23 (framework)
        - Seller: BT-27 (name), BT-29 (SIRET), BT-30 (SIREN), BT-31 (VAT)
        - Buyer: BT-44 (name), BT-46 (SIRET), BT-47 (SIREN), BT-48 (VAT)
        - Amounts: BT-109 (excl. tax), BT-110 (VAT), BT-112 (incl. tax), BT-115 (amount due)
        - VAT breakdown: BT-116, BT-117, BT-118, BT-119
        - Invoice lines: BT-153, BT-129, BT-146, BT-131
        - Mandatory notes: PMT, PMD, AAB
        - Rule BR-FR-09: SIRET/SIREN consistency

        **Advantages over synchronous version:**
        - OCR support for image PDFs (via DocTR service)
        - Longer timeout for large documents
        - Doesn't block the server
      operationId: verify_pdf_async_api_v1_verification_verify_async_post
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/Body_verify_pdf_async_api_v1_verification_verify_async_post"
        required: true
      responses:
        "202":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Verify PDF/XML Factur-X compliance (asynchronous)
      tags:
      - PDF/XML Verification
      - PDF/XML Verification
      x-content-type: multipart/form-data
      x-accepts:
      - application/json
  /api/v1/verification/verify-async/{task_id}/status:
    get:
      description: |-
        Retrieves the status and result of an asynchronous verification task.

        **Possible statuses:**
        - `PENDING`: Task waiting in queue
        - `STARTED`: Task currently running
        - `SUCCESS`: Task completed successfully (see `result`)
        - `FAILURE`: System error (unhandled exception)

        **Note:** The `result.status` field can be "SUCCESS" or "ERROR"
        independently of Celery status (which will always be SUCCESS if the task ran).
      operationId: get_verification_status_api_v1_verification_verify_async__task_id__status_get
      parameters:
      - explode: false
        in: path
        name: task_id
        required: true
        schema:
          title: Task Id
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AsyncTaskStatus"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      security:
      - HTTPBearer: []
      summary: Get status of an asynchronous verification
      tags:
      - PDF/XML Verification
      - PDF/XML Verification
      x-accepts:
      - application/json
  /:
    get:
      description: |-
        Health check endpoint to verify the API is responding.

        Useful for:
        - Availability monitoring
        - Integration tests
        - Load balancers
      operationId: root__get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: API is operational
      summary: Check API status
      tags:
      - Health
      x-accepts:
      - application/json
  /healthcheck:
    get:
      description: |-
        Healthcheck endpoint for Docker and load balancers.

        Useful for:
        - Docker healthcheck
        - Kubernetes liveness/readiness probes
        - Load balancers (Nginx, HAProxy)
        - Availability monitoring
        - Zero downtime deployment

        Returns a 200 code if the API is operational.
      operationId: healthcheck_healthcheck_get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: API is healthy
      summary: Docker healthcheck endpoint
      tags:
      - Health
      x-accepts:
      - application/json
  /api/v1/me:
    get:
      description: |-
        Returns information about the authenticated user.

        This endpoint allows you to:
        - Verify that authentication works
        - Get connected account details
        - Test JWT token validity
        - Check your consumption quota

        **Requires valid authentication.**
      operationId: get_user_info_api_v1_me_get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: User information
      security:
      - HTTPBearer: []
      summary: Get current user information
      tags:
      - User
      x-accepts:
      - application/json
components:
  schemas:
    AFNORCredentials:
      description: |-
        Optional AFNOR PDP credentials.

        **MODE 1 - JWT retrieval (recommended):**
        Do not provide this `credentials` field in the payload.
        PDP credentials will be automatically retrieved via client_uid from JWT (0-trust).

        **MODE 2 - Credentials in payload (zero-storage):**
        Provide all required fields below.
        Useful for tests or third-party integrations.
      example:
        clientId: my_pdp_client_id
        clientSecret: my_pdp_secret
        flowServiceUrl: https://api-pdp.example.com/flow/v1
      properties:
        clientId:
          nullable: true
          type: string
        clientSecret:
          nullable: true
          type: string
        flowServiceUrl:
          nullable: true
          type: string
      title: AFNORCredentials
    AFNORDestination:
      description: Specific configuration for AFNOR PDP destination.
      properties:
        type:
          default: afnor
          enum:
          - afnor
          title: Type
          type: string
        credentials:
          allOf:
          - $ref: "#/components/schemas/AFNORCredentials"
          nullable: true
        flowSyntax:
          default: Factur-X
          description: Flow syntax to send
          enum:
          - Factur-X
          - CII
          - UBL
          title: Flowsyntax
          type: string
        trackingId:
          nullable: true
          type: string
      title: AFNORDestination
    AFNORResult:
      description: Result of submission to AFNOR PDP.
      properties:
        flowId:
          description: Submitted flow identifier
          title: Flowid
          type: string
        trackingId:
          nullable: true
          type: string
        sha256:
          description: SHA-256 hash of submitted file
          title: Sha256
          type: string
        flowSyntax:
          description: Flow syntax
          title: Flowsyntax
          type: string
        flowProfile:
          nullable: true
          type: string
      required:
      - flowId
      - flowSyntax
      - sha256
      title: AFNORResult
    APIError:
      description: |-
        Standardized API error (aligned with AFNOR Error schema).

        Unified format for all HTTP error responses.
      example:
        details:
        - code: SCHEMATRON_BR_FR_01
          item: BR-FR-01
          level: Error
          reason: Supplier SIRET is mandatory for French invoices
          source: schematron
        errorCode: VALIDATION_FAILED
        errorMessage: Factur-X validation failed
      properties:
        errorCode:
          description: Alphanumeric code precisely identifying the error
          title: Errorcode
          type: string
        errorMessage:
          description: Message describing the error (not intended for end user)
          title: Errormessage
          type: string
        details:
          items:
            $ref: "#/components/schemas/ValidationErrorDetail"
          nullable: true
          type: array
      required:
      - errorCode
      - errorMessage
      title: APIError
    APIProfile:
      description: Factur-X profile for API requests.
      enum:
      - MINIMUM
      - BASIC
      - EN16931
      - EXTENDED
      title: APIProfile
      type: string
    AsyncTaskStatus:
      description: |-
        Complete description of an async task status.

        The `status` field indicates the Celery state of the task.
        When `status="SUCCESS"`, check `result.status` for the business result ("SUCCESS" or "ERROR").
      example:
        result:
          key: ""
        taskId: taskId
        status: ""
      properties:
        taskId:
          description: Unique task identifier
          title: Taskid
          type: string
        status:
          allOf:
          - $ref: "#/components/schemas/CeleryStatus"
          description: "Celery task status (PENDING, STARTED, SUCCESS, FAILURE, RETRY)"
        result:
          additionalProperties: true
          nullable: true
          type: object
      required:
      - status
      - taskId
      title: AsyncTaskStatus
    Body_generate_invoice_api_v1_processing_generate_invoice_post:
      properties:
        invoice_data:
          description: "Invoice data in JSON format.\n\n            Two formats accepted:\n\
            \            1. **Classic format**: Complete FactureFacturX structure\
            \ (all fields)\n            2. **Simplified format** (üÜï P0.1): Minimal\
            \ structure with auto-enrichment\n\n            Format is detected automatically!\n\
            \            "
          title: Invoice Data
          type: string
        profile:
          allOf:
          - $ref: "#/components/schemas/APIProfile"
          default: EXTENDED
          description: "Factur-X profile: MINIMUM, BASIC, EN16931 or EXTENDED."
        output_format:
          allOf:
          - $ref: "#/components/schemas/OutputFormat"
          default: xml
          description: "Output format: 'xml' (XML only) or 'pdf' (Factur-X PDF with\
            \ embedded XML)."
        auto_enrich:
          default: true
          description: üÜï Enable auto-enrichment from SIRET/SIREN (simplified format
            only)
          title: Auto Enrich
          type: boolean
        source_pdf:
          format: binary
          nullable: true
          type: string
      required:
      - invoice_data
      title: Body_generate_invoice_api_v1_processing_generate_invoice_post
    Body_sign_pdf_api_v1_processing_sign_pdf_post:
      properties:
        pdf_file:
          description: PDF file to sign (will be processed and returned signed in
            base64)
          format: binary
          title: Pdf File
          type: string
        reason:
          nullable: true
          type: string
        location:
          nullable: true
          type: string
        contact:
          nullable: true
          type: string
        field_name:
          default: FactPulseSignature
          description: PDF signature field name
          example: FactPulseSignature
          title: Field Name
          type: string
        use_pades_lt:
          default: false
          description: Enable PAdES-B-LT (long-term archiving with embedded validation
            data). REQUIRES a certificate with OCSP/CRL access.
          title: Use Pades Lt
          type: boolean
        use_timestamp:
          default: true
          description: Enable RFC 3161 timestamping with FreeTSA (PAdES-B-T)
          title: Use Timestamp
          type: boolean
      required:
      - pdf_file
      title: Body_sign_pdf_api_v1_processing_sign_pdf_post
    Body_sign_pdf_async_api_v1_processing_sign_pdf_async_post:
      properties:
        pdf_file:
          description: PDF file to sign (processed asynchronously)
          format: binary
          title: Pdf File
          type: string
        reason:
          nullable: true
          type: string
        location:
          nullable: true
          type: string
        contact:
          nullable: true
          type: string
        field_name:
          default: FactPulseSignature
          description: PDF signature field name
          example: FactPulseSignature
          title: Field Name
          type: string
        use_pades_lt:
          default: false
          description: Enable PAdES-B-LT (long-term archiving with embedded validation
            data). REQUIRES a certificate with OCSP/CRL access.
          title: Use Pades Lt
          type: boolean
        use_timestamp:
          default: true
          description: Enable RFC 3161 timestamping with FreeTSA (PAdES-B-T)
          title: Use Timestamp
          type: boolean
      required:
      - pdf_file
      title: Body_sign_pdf_async_api_v1_processing_sign_pdf_async_post
    Body_validate_facturx_pdf_api_v1_processing_validate_facturx_pdf_post:
      properties:
        pdf_file:
          description: Factur-X PDF file to validate (.pdf format).
          format: binary
          title: Pdf File
          type: string
        profile:
          allOf:
          - $ref: "#/components/schemas/APIProfile"
          nullable: true
        use_verapdf:
          default: false
          description: "Enable strict PDF/A validation with VeraPDF (recommended for\
            \ production). If False, uses basic metadata validation."
          title: Use Verapdf
          type: boolean
      required:
      - pdf_file
      title: Body_validate_facturx_pdf_api_v1_processing_validate_facturx_pdf_post
    Body_validate_facturx_pdf_async_api_v1_processing_validate_facturx_async_post:
      properties:
        pdf_file:
          description: Factur-X PDF file to validate (.pdf format).
          format: binary
          title: Pdf File
          type: string
        profile:
          allOf:
          - $ref: "#/components/schemas/APIProfile"
          nullable: true
        use_verapdf:
          default: false
          description: Enable strict PDF/A validation with VeraPDF (recommended for
            production). May take several seconds.
          title: Use Verapdf
          type: boolean
      required:
      - pdf_file
      title: Body_validate_facturx_pdf_async_api_v1_processing_validate_facturx_async_post
    Body_validate_pdf_signature_endpoint_api_v1_processing_validate_pdf_signature_post:
      properties:
        pdf_file:
          description: PDF file to validate (will be analyzed to detect and validate
            signatures)
          format: binary
          title: Pdf File
          type: string
      required:
      - pdf_file
      title: Body_validate_pdf_signature_endpoint_api_v1_processing_validate_pdf_signature_post
    Body_validate_xml_api_v1_processing_validate_xml_post:
      properties:
        xml_file:
          description: Factur-X XML file to validate (.xml format).
          format: binary
          title: Xml File
          type: string
        profile:
          allOf:
          - $ref: "#/components/schemas/APIProfile"
          default: EXTENDED
          description: "Validation profile (MINIMUM, BASIC, EN16931, EXTENDED)."
      required:
      - xml_file
      title: Body_validate_xml_api_v1_processing_validate_xml_post
    Body_verify_pdf_async_api_v1_verification_verify_async_post:
      properties:
        pdf_file:
          description: Factur-X PDF file to verify
          format: binary
          title: Pdf File
          type: string
        force_ocr:
          default: false
          description: Force OCR usage even if PDF contains native text
          title: Force Ocr
          type: boolean
      required:
      - pdf_file
      title: Body_verify_pdf_async_api_v1_verification_verify_async_post
    Body_verify_pdf_sync_api_v1_verification_verify_post:
      properties:
        pdf_file:
          description: Factur-X PDF file to verify
          format: binary
          title: Pdf File
          type: string
      required:
      - pdf_file
      title: Body_verify_pdf_sync_api_v1_verification_verify_post
    BoundingBoxSchema:
      description: |-
        Rectangular area coordinates in PDF.

        Coordinates are in PDF points (1 point = 1/72 inch).
        Origin (0,0) is at the bottom-left of the page.
      example:
        height: 15.0
        page: 0
        width: 70.3
        x0: 350.5
        x1: 420.8
        y0: 720.0
        y1: 735.0
      properties:
        x0:
          description: Left X coordinate
          title: X0
          type: number
        y0:
          description: Bottom Y coordinate
          title: Y0
          type: number
        x1:
          description: Right X coordinate
          title: X1
          type: number
        y1:
          description: Top Y coordinate
          title: Y1
          type: number
        page:
          default: 0
          description: Page number (0-indexed)
          minimum: 0.0
          title: Page
          type: integer
        width:
          description: Area width
          title: Width
          type: number
        height:
          description: Area height
          title: Height
          type: number
      required:
      - height
      - width
      - x0
      - x1
      - y0
      - y1
      title: BoundingBoxSchema
    CeleryStatus:
      description: |-
        Possible states of a Celery task during polling.

        **Possible values:**
        - `PENDING`: Task waiting for processing
        - `STARTED`: Task currently executing
        - `SUCCESS`: Task completed successfully (check `result.status` for business result)
        - `FAILURE`: System error during execution (crash, unhandled exception)
        - `RETRY`: Retry attempt in progress (after temporary failure)
      enum:
      - PENDING
      - STARTED
      - SUCCESS
      - FAILURE
      - RETRY
      title: CeleryStatus
      type: string
    CertificateInfoResponse:
      description: Information about a generated certificate.
      properties:
        cn:
          description: Common Name
          example: Test Signature Client XYZ
          title: Cn
          type: string
        organization:
          description: Organization
          example: Client XYZ SARL
          title: Organization
          type: string
        country:
          description: Country code
          example: FR
          title: Country
          type: string
        city:
          description: City
          example: Lyon
          title: City
          type: string
        state:
          description: State/Province
          example: Rhone-Alpes
          title: State
          type: string
        email:
          nullable: true
          type: string
        subject:
          description: Full subject (RFC4514)
          example: "CN=Test Signature Client XYZ,O=Client XYZ SARL,L=Lyon,ST=Rhone-Alpes,C=FR"
          title: Subject
          type: string
        issuer:
          description: Issuer (self-signed = same as subject)
          example: "CN=Test Signature Client XYZ,O=Client XYZ SARL,L=Lyon,ST=Rhone-Alpes,C=FR"
          title: Issuer
          type: string
        serialNumber:
          description: Certificate serial number
          example: 123456789
          title: Serialnumber
          type: integer
        validFrom:
          description: Validity start date (ISO 8601)
          example: 2025-01-07T12:00:00+00:00
          title: Validfrom
          type: string
        validTo:
          description: Validity end date (ISO 8601)
          example: 2026-01-07T12:00:00+00:00
          title: Validto
          type: string
        algorithm:
          description: Signature algorithm
          example: sha256WithRSAEncryption
          title: Algorithm
          type: string
      required:
      - algorithm
      - city
      - cn
      - country
      - issuer
      - organization
      - serialNumber
      - state
      - subject
      - validFrom
      - validTo
      title: CertificateInfoResponse
    ChorusProDestination:
      description: Specific configuration for Chorus Pro destination.
      properties:
        type:
          default: chorus_pro
          enum:
          - chorus_pro
          title: Type
          type: string
        credentials:
          allOf:
          - $ref: "#/components/schemas/facture_electronique__rest_api__schemas__processing__ChorusProCredentials"
          nullable: true
      title: ChorusProDestination
    ChorusProResult:
      description: Result of submission to Chorus Pro.
      properties:
        chorusInvoiceId:
          description: Chorus Pro invoice ID
          title: Chorusinvoiceid
          type: integer
        depositFlowNumber:
          nullable: true
          type: string
        attachmentId:
          nullable: true
          type: integer
      required:
      - chorusInvoiceId
      title: ChorusProResult
    DocumentType:
      description: |-
        Commercial document types (UNTDID 1001).

        | Code | Name | Description |
        |------|------|-------------|
        | 380 | INVOICE | Commercial invoice |
        | 381 | CREDIT_NOTE | Credit note |
        | 384 | CORRECTED_INVOICE | Corrected invoice |
        | 386 | PREPAYMENT | Prepayment invoice |
        | 389 | SELF_BILLED | Self-billed invoice |
      enum:
      - "380"
      - "381"
      - "384"
      - "386"
      - "389"
      title: DocumentType
      type: string
      x-enum-descriptions:
      - Commercial invoice
      - Credit note
      - Corrected invoice
      - Prepayment invoice
      - Self-billed invoice
      x-enum-varnames:
      - INVOICE
      - CREDIT_NOTE
      - CORRECTED_INVOICE
      - PREPAYMENT
      - SELF_BILLED
    ElectronicAddress:
      description: |-
        Represents an electronic invoicing address, composed of an identifier
        and its scheme (SchemeID) in accordance with EN16931.
        Example: { "identifier": "123456789", "scheme_id": "0225" }
      properties:
        identifier:
          title: Identifier
          type: string
        schemeId:
          allOf:
          - $ref: "#/components/schemas/SchemeID"
          default: "0225"
      required:
      - identifier
      title: ElectronicAddress
    EnrichedInvoiceInfo:
      description: Information about the enriched invoice.
      properties:
        invoiceNumber:
          title: Invoicenumber
          type: string
        supplierId:
          nullable: true
          type: integer
        recipientId:
          nullable: true
          type: integer
        supplierName:
          title: Suppliername
          type: string
        recipientName:
          title: Recipientname
          type: string
        totalNetAmount:
          pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
          title: EnrichedNetAmount
          type: string
        vatAmount:
          pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
          title: EnrichedVatAmount
          type: string
        totalGrossAmount:
          pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
          title: EnrichedGrossAmount
          type: string
      required:
      - invoiceNumber
      - recipientName
      - supplierName
      - totalGrossAmount
      - totalNetAmount
      - vatAmount
      title: EnrichedInvoiceInfo
    ErrorLevel:
      enum:
      - Error
      - Warning
      type: string
    ErrorSource:
      enum:
      - schematron
      - pdfa
      - pydantic
      - xmp
      - signature
      - afnor
      - chorus_pro
      - system
      type: string
    FacturXPDFInfo:
      description: Information about the generated Factur-X PDF.
      properties:
        size:
          description: PDF size in bytes
          title: Size
          type: integer
        profile:
          description: Factur-X profile used
          title: Profile
          type: string
        signed:
          default: false
          description: PDF electronically signed
          title: Signed
          type: boolean
      required:
      - profile
      - size
      title: FacturXPDFInfo
    FieldStatus:
      description: Field compliance status.
      enum:
      - COMPLIANT
      - DISCREPANCY
      - MISSING_IN_PDF
      - MISSING_IN_XML
      - NOT_VERIFIED
      title: FieldStatus
      type: string
    GenerateCertificateRequest:
      description: |-
        Request to generate a self-signed X.509 test certificate.

        WARNING: This certificate is intended for TESTING only.
        DO NOT use in production!
        eIDAS level: SES (Simple Electronic Signature)
      example:
        city: Lyon
        cn: Test Signature Client XYZ
        country: FR
        email: contact@xyz.fr
        generateP12: false
        keySize: 2048
        organization: Client XYZ SARL
        p12Passphrase: changeme
        state: Rhone-Alpes
        validityDays: 365
      properties:
        cn:
          default: Test Signature FactPulse
          description: Common Name (CN) - Certificate name
          example: Test Signature Client XYZ
          title: Cn
          type: string
        organization:
          default: FactPulse Test
          description: Organization (O)
          example: Client XYZ SARL
          title: Organization
          type: string
        country:
          default: FR
          description: ISO 2-letter country code (C)
          example: FR
          maxLength: 2
          minLength: 2
          title: Country
          type: string
        city:
          default: Paris
          description: City (L)
          example: Paris
          title: City
          type: string
        state:
          default: Ile-de-France
          description: State/Province (ST)
          example: Ile-de-France
          title: State
          type: string
        email:
          nullable: true
          type: string
        validity_days:
          default: 365
          description: Validity duration in days
          example: 365
          maximum: 3650.0
          minimum: 1.0
          title: Validity Days
          type: integer
        key_size:
          default: 2048
          description: RSA key size in bits
          example: 2048
          title: Key Size
          type: integer
        key_passphrase:
          nullable: true
          type: string
        generate_p12:
          default: false
          description: Also generate a PKCS#12 (.p12) file
          example: false
          title: Generate P12
          type: boolean
        p12_passphrase:
          default: changeme
          description: Passphrase for PKCS#12 file
          example: changeme
          title: P12 Passphrase
          type: string
      title: GenerateCertificateRequest
    GenerateCertificateResponse:
      description: |-
        Response after generating a test certificate.

        Contains certificate PEM, private key PEM, and optionally PKCS#12.
      example:
        certificatePem: |-
          -----BEGIN CERTIFICATE-----
          MIID...
          -----END CERTIFICATE-----
        info:
          algorithm: sha256WithRSAEncryption
          city: Lyon
          cn: Test Signature Client XYZ
          country: FR
          email: contact@xyz.fr
          issuer: "CN=Test Signature Client XYZ,O=Client XYZ SARL,L=Lyon,ST=Rhone-Alpes,C=FR"
          organization: Client XYZ SARL
          serialNumber: 123456789
          state: Rhone-Alpes
          subject: "CN=Test Signature Client XYZ,O=Client XYZ SARL,L=Lyon,ST=Rhone-Alpes,C=FR"
          validFrom: 2025-01-07T12:00:00+00:00
          validTo: 2026-01-07T12:00:00+00:00
        privateKeyPem: |-
          -----BEGIN PRIVATE KEY-----
          MIIE...
          -----END PRIVATE KEY-----
        status: success
        warning: "WARNING: This certificate is SELF-SIGNED and intended for TESTING\
          \ only. DO NOT use in production. eIDAS level: SES (Simple Electronic Signature)"
      properties:
        status:
          default: success
          description: Operation status
          example: success
          title: Status
          type: string
        certificatePem:
          description: X.509 certificate in PEM format
          example: |-
            -----BEGIN CERTIFICATE-----
            MIID...
            -----END CERTIFICATE-----
          title: Certificatepem
          type: string
        privateKeyPem:
          description: RSA private key in PEM format
          example: |-
            -----BEGIN PRIVATE KEY-----
            MIIE...
            -----END PRIVATE KEY-----
          title: Privatekeypem
          type: string
        pkcs12Base64:
          nullable: true
          type: string
        info:
          allOf:
          - $ref: "#/components/schemas/CertificateInfoResponse"
          description: Generated certificate information
        warning:
          default: "WARNING: This certificate is SELF-SIGNED and intended for TESTING\
            \ only. DO NOT use in production. eIDAS level: SES (Simple Electronic\
            \ Signature)"
          description: Warning about certificate usage
          title: Warning
          type: string
      required:
      - certificatePem
      - info
      - privateKeyPem
      title: GenerateCertificateResponse
    GetChorusProIdRequest:
      description: Get Chorus Pro ID from SIRET.
      example:
        credentials: ""
        identifier_type: SIRET
        siret: siret
      properties:
        credentials:
          allOf:
          - $ref: "#/components/schemas/facture_electronique__rest_api__schemas__chorus_pro__ChorusProCredentials"
          nullable: true
        siret:
          description: Structure SIRET (14 digits)
          title: Siret
          type: string
        identifier_type:
          default: SIRET
          description: "Identifier type (SIRET, SIREN, UE_HORS_FRANCE, etc.)"
          title: Identifier Type
          type: string
      required:
      - siret
      title: GetChorusProIdRequest
    GetChorusProIdResponse:
      description: Found Chorus Pro ID.
      example:
        structureIdentifier: structureIdentifier
        structureName: structureName
        structureId: 0
        message: message
      properties:
        structureId:
          description: Chorus Pro ID (0 if not found)
          title: Structureid
          type: integer
        structureIdentifier:
          description: Searched SIRET/SIREN
          title: Structureidentifier
          type: string
        structureName:
          nullable: true
          type: string
        message:
          description: Return message
          title: Message
          type: string
      required:
      - message
      - structureId
      - structureIdentifier
      title: GetChorusProIdResponse
    GetInvoiceRequest:
      description: Get an invoice.
      example:
        credentials: ""
        chorus_invoice_id: 0
      properties:
        credentials:
          allOf:
          - $ref: "#/components/schemas/facture_electronique__rest_api__schemas__chorus_pro__ChorusProCredentials"
          nullable: true
        chorus_invoice_id:
          description: Chorus Pro invoice ID
          title: Chorus Invoice Id
          type: integer
      required:
      - chorus_invoice_id
      title: GetInvoiceRequest
    GetInvoiceResponse:
      description: Invoice details.
      example:
        returnCode: 0
        recipientStructureName: recipientStructureName
        chorusInvoiceId: 6
        currentStatus: ""
        invoiceNumber: invoiceNumber
        recipientStructureId: 1
        totalGrossAmount: totalGrossAmount
        message: message
        invoiceDate: invoiceDate
      properties:
        returnCode:
          title: Returncode
          type: integer
        message:
          title: Message
          type: string
        chorusInvoiceId:
          nullable: true
          type: integer
        invoiceNumber:
          nullable: true
          type: string
        invoiceDate:
          nullable: true
          type: string
        totalGrossAmount:
          nullable: true
          type: string
        currentStatus:
          allOf:
          - $ref: "#/components/schemas/InvoiceStatus"
          nullable: true
        recipientStructureId:
          nullable: true
          type: integer
        recipientStructureName:
          nullable: true
          type: string
      required:
      - message
      - returnCode
      title: GetInvoiceResponse
    GetStructureRequest:
      description: Get structure details.
      example:
        language_code: fr
        credentials: ""
        structure_id: 0
      properties:
        credentials:
          allOf:
          - $ref: "#/components/schemas/facture_electronique__rest_api__schemas__chorus_pro__ChorusProCredentials"
          nullable: true
        structure_id:
          description: Chorus Pro structure ID
          title: Structure Id
          type: integer
        language_code:
          default: fr
          description: "Language code (fr, en)"
          title: Language Code
          type: string
      required:
      - structure_id
      title: GetStructureRequest
    GetStructureResponse:
      description: Structure details.
      example:
        returnCode: 0
        structureLabel: structureLabel
        structureIdentifier: structureIdentifier
        companyName: companyName
        structureId: 6
        structureEmail: structureEmail
        message: message
        parameters: ""
        vatNumber: vatNumber
      properties:
        returnCode:
          title: Returncode
          type: integer
        message:
          title: Message
          type: string
        structureId:
          nullable: true
          type: integer
        structureIdentifier:
          nullable: true
          type: string
        structureLabel:
          nullable: true
          type: string
        companyName:
          nullable: true
          type: string
        vatNumber:
          nullable: true
          type: string
        structureEmail:
          nullable: true
          type: string
        parameters:
          allOf:
          - $ref: "#/components/schemas/StructureParameters"
          nullable: true
      required:
      - message
      - returnCode
      title: GetStructureResponse
    HTTPValidationError:
      example:
        detail:
        - msg: msg
          loc:
          - ValidationError_loc_inner
          - ValidationError_loc_inner
          type: type
        - msg: msg
          loc:
          - ValidationError_loc_inner
          - ValidationError_loc_inner
          type: type
      properties:
        detail:
          items:
            $ref: "#/components/schemas/ValidationError"
          type: array
      title: HTTPValidationError
    IncomingInvoice:
      description: |-
        Invoice received from a supplier via PDP/PA.

        This model contains essential metadata extracted from incoming invoices,
        regardless of their source format (CII, UBL, Factur-X).

        Amounts are Decimal in Python but will be serialized as
        strings in JSON to preserve monetary precision.
      example:
        supplierReference: supplierReference
        documentFilename: documentFilename
        documentContentType: documentContentType
        billingSiteName: billingSiteName
        documentType: ""
        netAmount: netAmount
        dueDate: dueDate
        grossAmount: grossAmount
        vatAmount: vatAmount
        supplier: ""
        purchaseOrderNumber: purchaseOrderNumber
        currency: EUR
        documentBase64: documentBase64
        issueDate: issueDate
        contractReference: contractReference
        flowId: flowId
        sourceFormat: ""
        billingSiteSiret: billingSiteSiret
        invoiceSubject: invoiceSubject
      properties:
        flowId:
          nullable: true
          type: string
        sourceFormat:
          allOf:
          - $ref: "#/components/schemas/InvoiceFormat"
          description: Invoice source format
        supplierReference:
          description: Invoice number issued by the supplier (BT-1)
          title: Supplierreference
          type: string
        documentType:
          allOf:
          - $ref: "#/components/schemas/DocumentType"
          default: "380"
          description: Document type (BT-3)
        supplier:
          allOf:
          - $ref: "#/components/schemas/IncomingSupplier"
          description: Invoice issuer (SellerTradeParty)
        billingSiteName:
          description: Recipient name / your company (BT-44)
          title: Billingsitename
          type: string
        billingSiteSiret:
          nullable: true
          type: string
        issueDate:
          description: Invoice date (BT-2) - YYYY-MM-DD
          title: Issuedate
          type: string
        dueDate:
          nullable: true
          type: string
        currency:
          default: EUR
          description: ISO currency code (BT-5)
          title: Currency
          type: string
        netAmount:
          description: Total net amount (BT-109)
          pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
          title: IncomingNetAmount
          type: string
        vatAmount:
          description: Total VAT amount (BT-110)
          pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
          title: IncomingVatAmount
          type: string
        grossAmount:
          description: Total gross amount (BT-112)
          pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
          title: IncomingGrossAmount
          type: string
        purchaseOrderNumber:
          nullable: true
          type: string
        contractReference:
          nullable: true
          type: string
        invoiceSubject:
          nullable: true
          type: string
        documentBase64:
          nullable: true
          type: string
        documentContentType:
          nullable: true
          type: string
        documentFilename:
          nullable: true
          type: string
      required:
      - billingSiteName
      - grossAmount
      - issueDate
      - netAmount
      - sourceFormat
      - supplier
      - supplierReference
      - vatAmount
      title: IncomingInvoice
    IncomingSupplier:
      description: |-
        Supplier extracted from an incoming invoice.

        Unlike the Supplier model in models.py, this model does not have
        a supplier_id field as this information is not available
        in Factur-X/CII/UBL XML files.
      properties:
        name:
          description: Supplier business name (BT-27)
          title: Name
          type: string
        siren:
          nullable: true
          type: string
        siret:
          nullable: true
          type: string
        vatNumber:
          nullable: true
          type: string
        postalAddress:
          allOf:
          - $ref: "#/components/schemas/PostalAddress"
          nullable: true
        electronicAddress:
          allOf:
          - $ref: "#/components/schemas/ElectronicAddress"
          nullable: true
        email:
          nullable: true
          type: string
        phone:
          nullable: true
          type: string
      required:
      - name
      title: IncomingSupplier
    InvoiceFormat:
      description: Supported invoice formats for extraction.
      enum:
      - CII
      - UBL
      - Factur-X
      title: InvoiceFormat
      type: string
    InvoiceStatus:
      description: Chorus Pro invoice status.
      properties:
        code:
          description: "Status code (SOUMISE, VALIDEE, REJETEE, SUSPENDUE, MANDATEE,\
            \ MISE_EN_PAIEMENT, etc.)"
          title: Code
          type: string
        label:
          description: Status label
          title: Label
          type: string
        date:
          nullable: true
          type: string
      required:
      - code
      - label
      title: InvoiceStatus
    MandatoryNoteSchema:
      description: Mandatory note detected with location and XML/PDF comparison.
      example:
        bbox:
          height: 5.8
          page: 0
          width: 61.6
          x0: 238.4
          x1: 300.0
          y0: 164.4
          y1: 170.2
        label: Recovery indemnity
        message: XML text found in PDF
        pdfValue: fixed indemnity of 40 euros
        status: COMPLIANT
        subjectCode: PMT
        xmlValue: "In case of late payment, a fixed indemnity of 40 euros will be\
          \ due."
      properties:
        subjectCode:
          description: "Subject code (PMT, PMD, AAB)"
          title: Subjectcode
          type: string
        label:
          description: "Label (e.g., Recovery indemnity)"
          title: Label
          type: string
        pdfValue:
          nullable: true
          type: string
        xmlValue:
          nullable: true
          type: string
        status:
          allOf:
          - $ref: "#/components/schemas/FieldStatus"
          default: NOT_VERIFIED
          description: Compliance status (COMPLIANT if XML found in PDF)
        message:
          nullable: true
          type: string
        bbox:
          allOf:
          - $ref: "#/components/schemas/BoundingBoxSchema"
          nullable: true
      required:
      - label
      - subjectCode
      title: MandatoryNoteSchema
    OutputFormat:
      description: Output format for invoice generation.
      enum:
      - xml
      - pdf
      title: OutputFormat
      type: string
    PDFValidationResultAPI:
      description: Complete result of a Factur-X PDF validation.
      example:
        pdfaValidationMethod: metadata
        signatureErrors:
        - signatureErrors
        - signatureErrors
        isSigned: true
        detectedProfile: detectedProfile
        summaryMessage: summaryMessage
        xmlPresent: true
        pdfaVersion: pdfaVersion
        xmlErrors:
        - xmlErrors
        - xmlErrors
        failedRules: 6
        isCompliant: true
        xmpErrors:
        - xmpErrors
        - xmpErrors
        signatures:
        - reason: reason
          fieldName: fieldName
          signingDate: signingDate
          isValid: true
          location: location
          signer: signer
        - reason: reason
          fieldName: fieldName
          signingDate: signingDate
          isValid: true
          location: location
          signer: signer
        pdfaWarnings:
        - pdfaWarnings
        - pdfaWarnings
        xmlCompliant: true
        pdfaErrors:
        - pdfaErrors
        - pdfaErrors
        pdfaCompliant: true
        validatedRules: 0
        xmpPresent: true
        xmpProfile: xmpProfile
        signatureCount: 1
        xmpFacturxCompliant: true
        xmpMetadata:
          key: ""
        xmpVersion: xmpVersion
      properties:
        isCompliant:
          description: "True if PDF complies with all criteria (XML, PDF/A, XMP)"
          title: Iscompliant
          type: boolean
        xmlPresent:
          description: True if a Factur-X XML is embedded in the PDF
          title: Xmlpresent
          type: boolean
        xmlCompliant:
          description: True if Factur-X XML complies with Schematron rules
          title: Xmlcompliant
          type: boolean
        detectedProfile:
          nullable: true
          type: string
        xmlErrors:
          description: List of XML validation errors
          items:
            type: string
          type: array
        pdfaCompliant:
          description: True if PDF is PDF/A compliant
          title: Pdfacompliant
          type: boolean
        pdfaVersion:
          nullable: true
          type: string
        pdfaValidationMethod:
          default: metadata
          description: Method used for PDF/A validation (metadata or verapdf)
          title: Pdfavalidationmethod
          type: string
        validatedRules:
          nullable: true
          type: integer
        failedRules:
          nullable: true
          type: integer
        pdfaErrors:
          description: List of PDF/A compliance errors
          items:
            type: string
          type: array
        pdfaWarnings:
          description: List of PDF/A warnings
          items:
            type: string
          type: array
        xmpPresent:
          description: True if XMP metadata is present
          title: Xmppresent
          type: boolean
        xmpFacturxCompliant:
          description: True if XMP metadata contains Factur-X information
          title: Xmpfacturxcompliant
          type: boolean
        xmpProfile:
          nullable: true
          type: string
        xmpVersion:
          nullable: true
          type: string
        xmpErrors:
          description: List of XMP metadata errors
          items:
            type: string
          type: array
        xmpMetadata:
          additionalProperties: true
          description: XMP metadata extracted from PDF
          title: Xmpmetadata
          type: object
        isSigned:
          description: True if PDF contains at least one signature
          title: Issigned
          type: boolean
        signatureCount:
          default: 0
          description: Number of electronic signatures found
          title: Signaturecount
          type: integer
        signatures:
          description: List of found signatures with their information
          items:
            $ref: "#/components/schemas/SignatureInfoAPI"
          type: array
        signatureErrors:
          description: List of errors during signature analysis
          items:
            type: string
          type: array
        summaryMessage:
          description: Message summarizing the validation result
          title: Summarymessage
          type: string
      required:
      - isCompliant
      - isSigned
      - pdfaCompliant
      - summaryMessage
      - xmlCompliant
      - xmlPresent
      - xmpFacturxCompliant
      - xmpPresent
      title: PDFValidationResultAPI
    PageDimensionsSchema:
      description: PDF page dimensions.
      example:
        height: 841.8
        width: 595.2
      properties:
        width:
          description: Width in PDF points
          title: Width
          type: number
        height:
          description: Height in PDF points
          title: Height
          type: number
      required:
      - height
      - width
      title: PageDimensionsSchema
    PostalAddress:
      description: Represents a postal address.
      properties:
        postalCode:
          nullable: true
          type: string
        lineOne:
          nullable: true
          type: string
        lineTwo:
          nullable: true
          type: string
        city:
          nullable: true
          type: string
        countryCode:
          nullable: true
          type: string
      title: PostalAddress
    ProcessingOptions:
      description: Processing options for generation and submission.
      example:
        autoEnrich: true
        facturxProfile: EN16931
        validate: true
        verifyDestinationParameters: true
      properties:
        facturxProfile:
          allOf:
          - $ref: "#/components/schemas/APIProfile"
          default: EN16931
          description: Factur-X profile to use
        autoEnrich:
          default: true
          description: "Auto-enrich data (Company APIs, Chorus Pro, etc.)"
          title: Autoenrich
          type: boolean
        validate:
          default: true
          description: Validate Factur-X XML with Schematron
          title: Validate
          type: boolean
        verifyDestinationParameters:
          default: true
          description: "Verify required parameters for destination (e.g., service_code\
            \ for Chorus)"
          title: Verifydestinationparameters
          type: boolean
      title: ProcessingOptions
    SchemeID:
      description: |-
        Identification scheme codes (Electronic Address Scheme - EAS),
        mainly for electronic invoice addressing.

        **Possible values:**
        - `0225`: FR_SIREN - French SIREN (most common for France, replaces old 0002)
        - `0088`: GLN - Global Location Number
        - `0060`: DUNS - Data Universal Numbering System
        - `9957`: FR_VAT_INTRA - French intra-community VAT number
        - `0199`: GLEIF - Global Legal Entity Identifier Foundation
      enum:
      - "0225"
      - "0088"
      - "0060"
      - "9957"
      - "0199"
      title: SchemeID
      type: string
      x-enum-varnames:
      - FR_SIREN
      - GLN
      - DUNS
      - FR_TVA_INTRA
      - GLEIF
      x-enum-descriptions:
      - "FR_SIREN - French SIREN (most common for France, replaces old 0002)"
      - GLN - Global Location Number (GLN)
      - DUNS - Data Universal Numbering System (DUNS)
      - FR_TVA_INTRA - French intra-community VAT number
      - GLEIF - Global Legal Entity Identifier Foundation (GLEIF)
    SearchServicesResponse:
      description: Structure services list.
      example:
        returnCode: 0
        total: 1
        services:
        - serviceCode: serviceCode
          serviceId: 6
          isActive: true
          serviceLabel: serviceLabel
        - serviceCode: serviceCode
          serviceId: 6
          isActive: true
          serviceLabel: serviceLabel
        message: message
      properties:
        returnCode:
          title: Returncode
          type: integer
        message:
          title: Message
          type: string
        services:
          items:
            $ref: "#/components/schemas/StructureService"
          type: array
        total:
          default: 0
          description: Number of services
          title: Total
          type: integer
      required:
      - message
      - returnCode
      title: SearchServicesResponse
    SearchStructureRequest:
      description: Search structures by criteria.
      example:
        credentials: ""
        company_name: company_name
        restrict_private_structures: false
        structure_identifier: structure_identifier
        structure_identifier_type: structure_identifier_type
      properties:
        credentials:
          allOf:
          - $ref: "#/components/schemas/facture_electronique__rest_api__schemas__chorus_pro__ChorusProCredentials"
          nullable: true
        structure_identifier:
          nullable: true
          type: string
        structure_identifier_type:
          nullable: true
          type: string
        company_name:
          nullable: true
          type: string
        restrict_private_structures:
          default: false
          description: Limit search to private structures only
          title: Restrict Private Structures
          type: boolean
      title: SearchStructureRequest
    SearchStructureResponse:
      description: Structure search response.
      example:
        returnCode: 0
        total: 1
        structures:
        - structureIdentifier: structureIdentifier
          structureName: structureName
          structureId: 6
          structureIdentifierType: structureIdentifierType
          status: status
        - structureIdentifier: structureIdentifier
          structureName: structureName
          structureId: 6
          structureIdentifierType: structureIdentifierType
          status: status
        message: message
      properties:
        returnCode:
          description: Return code (0 = success)
          title: Returncode
          type: integer
        message:
          description: Return message
          title: Message
          type: string
        structures:
          items:
            $ref: "#/components/schemas/StructureInfo"
          type: array
        total:
          default: 0
          description: Total number of results
          title: Total
          type: integer
      required:
      - message
      - returnCode
      title: SearchStructureResponse
    SignatureInfo:
      description: Information about the electronic signature.
      properties:
        signed:
          description: PDF was signed
          title: Signed
          type: boolean
        cn:
          nullable: true
          type: string
        expiration:
          nullable: true
          type: string
      required:
      - signed
      title: SignatureInfo
    SignatureInfoAPI:
      description: Information about an electronic signature in a PDF.
      example:
        reason: reason
        fieldName: fieldName
        signingDate: signingDate
        isValid: true
        location: location
        signer: signer
      properties:
        fieldName:
          description: Signature field name in the PDF
          title: Fieldname
          type: string
        signer:
          nullable: true
          type: string
        signingDate:
          nullable: true
          type: string
        reason:
          nullable: true
          type: string
        location:
          nullable: true
          type: string
        isValid:
          nullable: true
          type: boolean
      required:
      - fieldName
      title: SignatureInfoAPI
    SignatureParameters:
      description: |-
        Optional parameters to sign the generated PDF.

        **MODE 1 - Stored certificate (recommended):**
        Only provide metadata (reason, location, etc.).
        The certificate will be automatically retrieved via client_uid from JWT.
        eIDAS compliant PAdES-B-LT signature.

        **MODE 2 - Keys in payload (tests/special cases):**
        Provide key_pem + cert_pem directly in the payload.
        Accepted PEM format: raw ("-----BEGIN...") or base64.

        **Selection rule:**
        - If key_pem AND cert_pem provided ‚Üí Mode 2 (payload keys)
        - Otherwise ‚Üí Mode 1 (stored certificate retrieved via client_uid)
      properties:
        keyPem:
          nullable: true
          type: string
        certPem:
          nullable: true
          type: string
        keyPassphrase:
          nullable: true
          type: string
        reason:
          nullable: true
          type: string
        location:
          nullable: true
          type: string
        contact:
          nullable: true
          type: string
        fieldName:
          default: FactPulseSignature
          description: PDF signature field name
          title: Fieldname
          type: string
        usePadesLt:
          default: false
          description: Enable PAdES-B-LT (long-term archival). REQUIRES certificate
            with OCSP/CRL access
          title: Usepadeslt
          type: boolean
        useTimestamp:
          default: true
          description: Enable RFC 3161 timestamping with FreeTSA (PAdES-B-T)
          title: Usetimestamp
          type: boolean
      title: SignatureParameters
    SimplifiedInvoiceData:
      description: Simplified invoice data (minimal format for auto-enrichment).
      properties:
        number:
          description: Unique invoice number
          title: Number
          type: string
        supplier:
          additionalProperties: true
          description: "Supplier information (siret, iban, ...)"
          title: Supplier
          type: object
        recipient:
          additionalProperties: true
          description: "Recipient information (siret, ...)"
          title: Recipient
          type: object
        lines:
          description: Invoice lines
          items:
            additionalProperties: true
            type: object
          minItems: 1
          type: array
        date:
          nullable: true
          type: string
        dueDays:
          default: 30
          description: "Due date in days (default: 30)"
          maximum: 365.0
          minimum: 0.0
          title: Duedays
          type: integer
        comment:
          nullable: true
          type: string
        purchaseOrderReference:
          nullable: true
          type: string
        contractReference:
          nullable: true
          type: string
      required:
      - lines
      - number
      - recipient
      - supplier
      title: SimplifiedInvoiceData
    StructureInfo:
      description: Structure information.
      example:
        structureIdentifier: structureIdentifier
        structureName: structureName
        structureId: 6
        structureIdentifierType: structureIdentifierType
        status: status
      properties:
        structureId:
          description: Chorus Pro structure ID
          title: Structureid
          type: integer
        structureIdentifier:
          description: "Identifier (SIRET, SIREN)"
          title: Structureidentifier
          type: string
        structureName:
          description: Structure name
          title: Structurename
          type: string
        structureIdentifierType:
          description: Identifier type
          title: Structureidentifiertype
          type: string
        status:
          description: "Status (ACTIVE, INACTIVE)"
          title: Status
          type: string
      required:
      - status
      - structureId
      - structureIdentifier
      - structureIdentifierType
      - structureName
      title: StructureInfo
    StructureParameters:
      description: Mandatory structure parameters.
      properties:
        serviceCodeRequired:
          default: false
          description: Service code is mandatory
          title: Servicecoderequired
          type: boolean
        engagementNumberRequired:
          default: false
          description: Engagement number is mandatory
          title: Engagementnumberrequired
          type: boolean
        engagementOrServiceManagement:
          default: false
          description: EJ or service code management enabled
          title: Engagementorservicemanagement
          type: boolean
      title: StructureParameters
    StructureService:
      description: Structure service.
      example:
        serviceCode: serviceCode
        serviceId: 6
        isActive: true
        serviceLabel: serviceLabel
      properties:
        serviceId:
          description: Service ID
          title: Serviceid
          type: integer
        serviceCode:
          description: Service code
          title: Servicecode
          type: string
        serviceLabel:
          description: Service label
          title: Servicelabel
          type: string
        isActive:
          description: Service active
          title: Isactive
          type: boolean
      required:
      - isActive
      - serviceCode
      - serviceId
      - serviceLabel
      title: StructureService
    SubmitCompleteInvoiceRequest:
      description: |-
        Request to submit a complete invoice (generation + submission).

        Workflow:
        1. Auto-enrichment (optional)
        2. Factur-X PDF generation
        3. Signature (optional)
        4. Submission to destination
      example:
        destination:
          type: chorus_pro
        invoiceData:
          lines:
          - description: Consulting service
            quantity: 10
            unitPrice: 100.0
            vatRate: 20.0
          number: FACT-2025-001
          recipient:
            siret: "98765432109876"
          supplier:
            iban: FR7630006000011234567890189
            siret: "12345678901234"
        options:
          autoEnrich: true
          facturxProfile: EN16931
          validate: true
        signature:
          location: "Paris, France"
          reason: Factur-X compliance - Electronic signature
          usePadesLt: false
          useTimestamp: true
        sourcePdf: JVBERi0xLjQKJeLjz9MKMSAwIG9iaiA8PC...
      properties:
        invoiceData:
          allOf:
          - $ref: "#/components/schemas/SimplifiedInvoiceData"
          description: Invoice data in simplified format (see examples)
        sourcePdf:
          description: Base64-encoded source PDF (will be transformed to Factur-X)
          title: Sourcepdf
          type: string
        destination:
          $ref: "#/components/schemas/Destination"
        signature:
          allOf:
          - $ref: "#/components/schemas/SignatureParameters"
          nullable: true
        options:
          allOf:
          - $ref: "#/components/schemas/ProcessingOptions"
          description: Processing options
      required:
      - destination
      - invoiceData
      - sourcePdf
      title: SubmitCompleteInvoiceRequest
    SubmitCompleteInvoiceResponse:
      description: Complete response after automated submission.
      example:
        chorusResult:
          attachmentId: 78910
          chorusInvoiceId: 123456
          depositFlowNumber: FLUX-2025-001
        destinationType: chorus_pro
        enrichedInvoice:
          invoiceNumber: FACT-2025-001
          recipientId: 99986401
          recipientName: CLIENT SA
          supplierId: 26300989
          supplierName: MY COMPANY SARL
          totalGrossAmount: 1200.0
          totalNetAmount: 1000.0
          vatAmount: 200.0
        facturxPdf:
          profile: EN16931
          signed: true
          size: 125430
        message: Invoice successfully submitted to Chorus Pro
        pdfBase64: JVBERi0xLjcKJeLjz9MKNSAwIG9iago8PC9GaWx0ZXIvRmxhdGVE...
        signature:
          cn: MY COMPANY - Server Seal
          expiration: 2026-12-31T23:59:59Z
          signed: true
        success: true
      properties:
        success:
          description: Invoice was successfully submitted
          title: Success
          type: boolean
        destinationType:
          description: Destination type
          enum:
          - chorus_pro
          - afnor
          title: Destinationtype
          type: string
        chorusResult:
          allOf:
          - $ref: "#/components/schemas/ChorusProResult"
          nullable: true
        afnorResult:
          allOf:
          - $ref: "#/components/schemas/AFNORResult"
          nullable: true
        enrichedInvoice:
          allOf:
          - $ref: "#/components/schemas/EnrichedInvoiceInfo"
          description: Enriched invoice data
        facturxPdf:
          allOf:
          - $ref: "#/components/schemas/FacturXPDFInfo"
          description: Generated PDF information
        signature:
          allOf:
          - $ref: "#/components/schemas/SignatureInfo"
          nullable: true
        pdfBase64:
          description: Generated Factur-X PDF (and signed if requested) base64-encoded
          title: Pdfbase64
          type: string
        message:
          description: Return message
          title: Message
          type: string
      required:
      - destinationType
      - enrichedInvoice
      - facturxPdf
      - message
      - pdfBase64
      - success
      title: SubmitCompleteInvoiceResponse
    SubmitInvoiceRequest:
      description: Submit an invoice to Chorus Pro.
      example:
        main_attachment_id: 5
        total_net_amount: 6.027456183070403
        credentials: ""
        total_gross_amount: 5.962133916683182
        structure_id: 0
        engagement_number: engagement_number
        main_attachment_label: main_attachment_label
        invoice_date: invoice_date
        vat_amount: 1.4658129805029452
        purchase_order_reference: purchase_order_reference
        payment_due_date: payment_due_date
        service_code: service_code
        comment: comment
        contract_reference: contract_reference
        invoice_number: invoice_number
      properties:
        credentials:
          allOf:
          - $ref: "#/components/schemas/facture_electronique__rest_api__schemas__chorus_pro__ChorusProCredentials"
          nullable: true
        invoice_number:
          description: Invoice number
          title: Invoice Number
          type: string
        invoice_date:
          description: "Invoice date (ISO format: YYYY-MM-DD)"
          title: Invoice Date
          type: string
        payment_due_date:
          nullable: true
          type: string
        structure_id:
          description: Chorus Pro recipient structure ID
          title: Structure Id
          type: integer
        service_code:
          nullable: true
          type: string
        engagement_number:
          nullable: true
          type: string
        total_net_amount:
          $ref: "#/components/schemas/SubmitNetAmount"
        vat_amount:
          $ref: "#/components/schemas/SubmitVatAmount"
        total_gross_amount:
          $ref: "#/components/schemas/SubmitGrossAmount"
        main_attachment_id:
          nullable: true
          type: integer
        main_attachment_label:
          nullable: true
          type: string
        comment:
          nullable: true
          type: string
        purchase_order_reference:
          nullable: true
          type: string
        contract_reference:
          nullable: true
          type: string
      required:
      - invoice_date
      - invoice_number
      - structure_id
      - total_gross_amount
      - total_net_amount
      - vat_amount
      title: SubmitInvoiceRequest
    SubmitInvoiceResponse:
      description: Response after invoice submission.
      example:
        returnCode: 0
        chorusInvoiceId: 6
        depositFlowNumber: depositFlowNumber
        message: message
      properties:
        returnCode:
          description: Return code (0 = success)
          title: Returncode
          type: integer
        message:
          description: Return message
          title: Message
          type: string
        chorusInvoiceId:
          nullable: true
          type: integer
        depositFlowNumber:
          nullable: true
          type: string
      required:
      - message
      - returnCode
      title: SubmitInvoiceResponse
    TaskResponse:
      description: Immediate response after submitting an async task.
      example:
        taskId: taskId
      properties:
        taskId:
          description: Unique task identifier for polling
          title: Taskid
          type: string
      required:
      - taskId
      title: TaskResponse
    ValidationError:
      example:
        msg: msg
        loc:
        - ValidationError_loc_inner
        - ValidationError_loc_inner
        type: type
      properties:
        loc:
          items:
            $ref: "#/components/schemas/ValidationError_loc_inner"
          type: array
        msg:
          title: Message
          type: string
        type:
          title: Error Type
          type: string
      required:
      - loc
      - msg
      - type
      title: ValidationError
    ValidationErrorDetail:
      description: |-
        Validation error detail (aligned with AFNOR AcknowledgementDetail).

        Unified format for all Factur-X validation errors,
        compatible with AFNOR XP Z12-013 standard.
      properties:
        level:
          allOf:
          - $ref: "#/components/schemas/ErrorLevel"
          default: Error
          description: "Severity level: 'Error' or 'Warning'"
        item:
          description: "Identifier of the concerned element (XPath, field, BR-FR rule,\
            \ etc.)"
          title: Item
          type: string
        reason:
          description: Error description
          title: Reason
          type: string
        source:
          allOf:
          - $ref: "#/components/schemas/ErrorSource"
          nullable: true
        code:
          nullable: true
          type: string
      required:
      - item
      - reason
      title: ValidationErrorDetail
    ValidationErrorResponse:
      description: Response for validation errors.
      example:
        detail:
        - detail
        - detail
      properties:
        detail:
          description: List of detected validation errors.
          items:
            type: string
          type: array
      required:
      - detail
      title: ValidationErrorResponse
    ValidationSuccessResponse:
      description: Response for successful validation.
      example:
        message: message
      properties:
        message:
          description: Message confirming XML compliance.
          title: Message
          type: string
      required:
      - message
      title: ValidationSuccessResponse
    VerificationSuccessResponse:
      description: Successful verification response with unified data.
      example:
        complianceScore: 100.0
        compliantFieldsCount: 12
        facturxProfile: EN16931
        fields:
        - bbox:
            height: 15.0
            page: 0
            width: 70.3
            x0: 350.5
            x1: 420.8
            y0: 720.0
            y1: 735.0
          businessTerm: BT-1
          confidence: 0.95
          label: Invoice Number
          message: Compliant
          pdfValue: FACT-2024-001
          source: native_pdf
          status: COMPLIANT
          xmlValue: FACT-2024-001
        isCompliant: true
        isFacturx: true
        mandatoryNotes: []
        pageDimensions:
        - height: 841.8
          width: 595.2
        verifiedFieldsCount: 12
        warnings: []
      properties:
        isCompliant:
          description: True if no critical discrepancy
          title: Iscompliant
          type: boolean
        complianceScore:
          description: Compliance score (0-100%)
          maximum: 100.0
          minimum: 0.0
          title: Compliancescore
          type: number
        verifiedFieldsCount:
          default: 0
          description: Number of verified fields
          minimum: 0.0
          title: Verifiedfieldscount
          type: integer
        compliantFieldsCount:
          default: 0
          description: Number of compliant fields
          minimum: 0.0
          title: Compliantfieldscount
          type: integer
        isFacturx:
          default: false
          description: True if PDF contains Factur-X XML
          title: Isfacturx
          type: boolean
        facturxProfile:
          nullable: true
          type: string
        fields:
          description: "List of verified fields with values, statuses and PDF coordinates"
          items:
            $ref: "#/components/schemas/VerifiedFieldSchema"
          type: array
        mandatoryNotes:
          description: "Mandatory notes (PMT, PMD, AAB) with PDF location"
          items:
            $ref: "#/components/schemas/MandatoryNoteSchema"
          type: array
        pageDimensions:
          description: "Dimensions of each PDF page (width, height)"
          items:
            $ref: "#/components/schemas/PageDimensionsSchema"
          type: array
        warnings:
          description: Non-blocking warnings
          items:
            type: string
          type: array
      required:
      - complianceScore
      - isCompliant
      title: VerificationSuccessResponse
    VerifiedFieldSchema:
      description: A verified field with all its information (extraction + compliance
        + location).
      example:
        bbox:
          height: 15.0
          page: 0
          width: 70.3
          x0: 350.5
          x1: 420.8
          y0: 720.0
          y1: 735.0
        businessTerm: BT-1
        confidence: 0.95
        label: Invoice Number
        message: Compliant
        pdfValue: FACT-2024-001
        source: native_pdf
        status: COMPLIANT
        xmlValue: FACT-2024-001
      properties:
        businessTerm:
          description: "EN16931 Business Term (e.g., BT-1)"
          title: Businessterm
          type: string
        label:
          description: "Field label (e.g., Invoice Number)"
          title: Label
          type: string
        pdfValue:
          nullable: true
          type: string
        xmlValue:
          nullable: true
          type: string
        status:
          allOf:
          - $ref: "#/components/schemas/FieldStatus"
          description: Compliance status
        message:
          nullable: true
          type: string
        confidence:
          default: 1.0
          description: Confidence score (0-1)
          maximum: 1.0
          minimum: 0.0
          title: Confidence
          type: number
        source:
          default: native_pdf
          description: Extraction source
          title: Source
          type: string
        bbox:
          allOf:
          - $ref: "#/components/schemas/BoundingBoxSchema"
          nullable: true
      required:
      - businessTerm
      - label
      - status
      title: VerifiedFieldSchema
    facture_electronique__rest_api__schemas__chorus_pro__ChorusProCredentials:
      description: |-
        Chorus Pro credentials for Zero-Trust mode.

        **Zero-Trust Mode**: Credentials are passed in each request and are NEVER stored.

        **Security**:
        - Credentials are never persisted in the database
        - They are used only for the duration of the request
        - Secure transmission via HTTPS

        **Use cases**:
        - High-security environments (banks, administrations)
        - Strict GDPR compliance
        - Tests with temporary credentials
        - Users who don't want to store their credentials
      example:
        chorusProLogin: my_login@company.fr
        chorusProPassword: MyPassword123!
        pisteClientId: my_client_id
        pisteClientSecret: my_secret
        sandbox: true
      properties:
        piste_client_id:
          description: PISTE Client ID (government API portal)
          title: Piste Client Id
          type: string
        piste_client_secret:
          description: PISTE Client Secret
          title: Piste Client Secret
          type: string
        chorus_pro_login:
          description: Chorus Pro login
          title: Chorus Pro Login
          type: string
        chorus_pro_password:
          description: Chorus Pro password
          title: Chorus Pro Password
          type: string
        sandbox:
          default: true
          description: Use sandbox environment (true) or production (false)
          title: Sandbox
          type: boolean
      required:
      - chorus_pro_login
      - chorus_pro_password
      - piste_client_id
      - piste_client_secret
      title: ChorusProCredentials
    facture_electronique__rest_api__schemas__processing__ChorusProCredentials:
      description: |-
        Optional Chorus Pro credentials.

        **MODE 1 - JWT retrieval (recommended):**
        Do not provide this `credentials` field in the payload.
        Credentials will be automatically retrieved via client_uid from JWT (0-trust).

        **MODE 2 - Credentials in payload:**
        Provide all required fields below.
        Useful for tests or third-party integrations.
      example:
        chorusLogin: my_login@company.fr
        chorusPassword: MyPassword123!
        pisteClientId: my_piste_client_id
        pisteClientSecret: my_piste_secret
        sandboxMode: true
      properties:
        pisteClientId:
          nullable: true
          type: string
        pisteClientSecret:
          nullable: true
          type: string
        chorusLogin:
          nullable: true
          type: string
        chorusPassword:
          nullable: true
          type: string
        sandboxMode:
          default: true
          description: "[MODE 2] Use sandbox mode (default: True)"
          title: Sandboxmode
          type: boolean
      title: ChorusProCredentials
    AllowanceReasonCode:
      description: |-
        Standardized codes for allowance or charge reasons (EN 16931 standard).

        **Possible values:**
        - `AA`: ADVERTISING_ALLOWANCE - Advertising discount or rebate
        - `ABL`: PACKAGING_SURCHARGE - Packaging surcharge
        - `ADR`: OTHER_SERVICES - Other services
        - `ADT`: PICKUP_COST - Pickup cost
        - `FC`: FREIGHT_CHARGES - Freight/transport costs
        - `FI`: FINANCING_CHARGES - Financing charges
        - `LA`: LABELING - Labeling
      enum:
      - AA
      - ABL
      - ADR
      - ADT
      - FC
      - FI
      - LA
      title: AllowanceReasonCode
      type: string
    InvoiceLine:
      description: Represents a line item in an invoice.
      properties:
        line_number:
          title: Line Number
          type: integer
        reference:
          nullable: true
          type: string
        item_name:
          title: Item Name
          type: string
        quantity:
          $ref: "#/components/schemas/Quantity"
        unit:
          $ref: "#/components/schemas/UnitOfMeasure"
        unit_net_price:
          $ref: "#/components/schemas/UnitNetPrice"
        allowanceAmount:
          $ref: "#/components/schemas/InvoiceLine_allowanceAmount"
        lineNetAmount:
          $ref: "#/components/schemas/LineNetAmount"
        vat_rate:
          nullable: true
          type: string
        manual_vat_rate:
          $ref: "#/components/schemas/Manual_Vat_Rate"
        vat_category:
          allOf:
          - $ref: "#/components/schemas/VATCategory"
          nullable: true
        periodStartDate:
          nullable: true
          type: string
        periodEndDate:
          nullable: true
          type: string
        allowanceReasonCode:
          allOf:
          - $ref: "#/components/schemas/AllowanceReasonCode"
          nullable: true
        allowanceReason:
          nullable: true
          type: string
      required:
      - item_name
      - line_number
      - quantity
      - unit
      - unit_net_price
      title: InvoiceLine
    InvoiceNote:
      description: |-
        Invoice note (IncludedNote in Factur-X).

        Mandatory notes for BR-FR-05 are:
        - PMT: Fixed recovery fee
        - PMD: Late payment penalties
        - AAB: Early payment discount
      properties:
        subject_code:
          nullable: true
          type: string
        content:
          title: Content
          type: string
      required:
      - content
      title: InvoiceNote
    InvoiceReferences:
      description: "Contains various invoice references (currency, type, etc.)."
      properties:
        invoice_currency:
          default: EUR
          title: Invoice Currency
          type: string
        payment_means:
          $ref: "#/components/schemas/PaymentMeans"
        invoice_type:
          $ref: "#/components/schemas/InvoiceTypeCode"
        vat_accounting_code:
          $ref: "#/components/schemas/VATAccountingCode"
        contract_reference:
          nullable: true
          type: string
        vat_exemption_reason:
          nullable: true
          type: string
        purchase_order_reference:
          nullable: true
          type: string
        preceding_invoice_reference:
          nullable: true
          type: string
      required:
      - invoice_type
      - payment_means
      - vat_accounting_code
      title: InvoiceReferences
    InvoiceTotals:
      description: Contains all invoice total amounts.
      properties:
        total_net_amount:
          $ref: "#/components/schemas/TotalNetAmount"
        vat_amount:
          $ref: "#/components/schemas/TotalVATAmount"
        total_gross_amount:
          $ref: "#/components/schemas/TotalGrossAmount"
        amount_due:
          $ref: "#/components/schemas/AmountDue"
        prepayment:
          $ref: "#/components/schemas/InvoiceTotals_prepayment"
        globalAllowanceAmount:
          $ref: "#/components/schemas/GlobalAllowanceAmount"
        globalAllowanceReason:
          nullable: true
          type: string
      required:
      - amount_due
      - total_gross_amount
      - total_net_amount
      - vat_amount
      title: InvoiceTotals
    InvoicingFramework:
      description: |-
        Defines the invoicing framework.

        - invoicing_framework_code: Chorus Pro code (A1, A2, A9, A12) - used for B2G
        - operation_nature: Operation nature (B1, S1, M1, etc.) - priority for Factur-X

        If operation_nature is provided, it will be used directly in Factur-X XML (BT-23).
        Otherwise, the code will be derived from invoicing_framework_code via automatic mapping.

        Example:
            >>> framework = InvoicingFramework(
            ...     invoicing_framework_code=InvoicingFrameworkCode.A1_SUPPLIER_INVOICE,
            ...     operation_nature=OperationNature.GOODS  # Forces B1 instead of S1
            ... )
      properties:
        invoicing_framework_code:
          $ref: "#/components/schemas/InvoicingFrameworkCode"
        operation_nature:
          allOf:
          - $ref: "#/components/schemas/OperationNature"
          nullable: true
        approver_service_code:
          nullable: true
          type: string
        approver_structure_code:
          nullable: true
          type: string
      required:
      - invoicing_framework_code
      title: InvoicingFramework
    InvoicingFrameworkCode:
      description: Chorus Pro codes for invoicing framework (B2G usage).
      enum:
      - A1_FACTURE_FOURNISSEUR
      - A2_FACTURE_FOURNISSEUR_DEJA_PAYEE
      - A9_FACTURE_SOUSTRAITANT
      - A12_FACTURE_COTRAITANT
      title: InvoicingFrameworkCode
      type: string
    OperationNature:
      description: |-
        Operation nature (BT-23) for Factur-X - French Reform.

        BR-FR-08: The invoicing framework must be one of the following codes.
        First letter indicates: B = Goods, S = Services, M = Mixed.

        Ref: XP Z12-012, article_conformite_pdf_facturx.md

        Example:
            >>> framework = InvoicingFramework(
            ...     invoicing_framework_code=InvoicingFrameworkCode.A1_SUPPLIER_INVOICE,
            ...     operation_nature=OperationNature.GOODS
            ... )
      enum:
      - B1
      - S1
      - M1
      - B2
      - S2
      - M2
      - B4
      - S4
      - M4
      - S3
      - S5
      - S6
      - B7
      - S7
      title: OperationNature
      type: string
    Payee:
      description: |-
        Information about the payment beneficiary (BG-10 / PayeeTradeParty).

        The payee is the party receiving payment. This block is used
        only if the payee is different from the seller (supplier).

        **Main use case**: Factoring
        When an invoice is factored, the factor (factoring company) becomes
        the payment beneficiary instead of the supplier.

        **Business Terms (EN16931)**:
        - BT-59: Payee name (mandatory)
        - BT-60: Payee identifier (SIRET with schemeID 0009)
        - BT-61: Payee legal identifier (SIREN with schemeID 0002)

        **Reference**: docs/guide_affacturage.md
      properties:
        nom:
          description: Payee name (BT-59). Mandatory.
          minLength: 1
          title: Nom
          type: string
        siret:
          nullable: true
          pattern: "^\\d{14}$"
          type: string
        siren:
          nullable: true
          pattern: "^\\d{9}$"
          type: string
        electronicAddress:
          allOf:
          - $ref: "#/components/schemas/ElectronicAddress"
          nullable: true
        iban:
          nullable: true
          type: string
        bic:
          nullable: true
          type: string
      required:
      - nom
      title: Payee
    PaymentMeans:
      description: Accepted payment methods.
      enum:
      - CHEQUE
      - PRELEVEMENT
      - VIREMENT
      - ESPECE
      - AUTRE
      - REPORT
      title: PaymentMeans
      type: string
    Recipient:
      description: Information about the invoice recipient (the customer).
      properties:
        electronic_address:
          allOf:
          - $ref: "#/components/schemas/ElectronicAddress"
          nullable: true
        executing_service_code:
          nullable: true
          type: string
        name:
          nullable: true
          type: string
        siren:
          nullable: true
          type: string
        siret:
          nullable: true
          type: string
        postal_address:
          allOf:
          - $ref: "#/components/schemas/PostalAddress"
          nullable: true
      required:
      - electronic_address
      title: Recipient
    SubmissionMode:
      description: Invoice submission mode on Chorus Pro.
      enum:
      - SAISIE_API
      - DEPOT_PDF_API
      - DEPOT_PDF_SIGNE_API
      title: SubmissionMode
      type: string
    SupplementaryAttachment:
      description: Represents a supplementary attachment.
      properties:
        description:
          title: Description
          type: string
        id:
          title: Id
          type: integer
        linkId:
          title: Linkid
          type: integer
        invoiceLineNumber:
          title: Invoicelinenumber
          type: integer
        type:
          title: Type
          type: string
      required:
      - description
      - id
      - invoiceLineNumber
      - linkId
      - type
      title: SupplementaryAttachment
    Supplier:
      description: Information about the supplier who issues the invoice.
      properties:
        electronic_address:
          allOf:
          - $ref: "#/components/schemas/ElectronicAddress"
          nullable: true
        supplier_id:
          title: Supplier Id
          type: integer
        supplier_bank_account_code:
          nullable: true
          type: integer
        supplier_service_id:
          nullable: true
          type: integer
        name:
          nullable: true
          type: string
        siren:
          nullable: true
          type: string
        siret:
          nullable: true
          type: string
        vat_number:
          nullable: true
          type: string
        iban:
          nullable: true
          type: string
        postal_address:
          allOf:
          - $ref: "#/components/schemas/PostalAddress"
          nullable: true
      required:
      - electronic_address
      - supplier_id
      title: Supplier
    UnitOfMeasure:
      description: Enumeration of invoicing units of measure.
      enum:
      - PIECE
      - HEURE
      - JOUR
      - KILOGRAMME
      - LITRE
      - FORFAIT
      title: UnitOfMeasure
      type: string
    VATAccountingCode:
      description: VAT accounting regime.
      enum:
      - TVA_SUR_DEBIT
      - TVA_SUR_ENCAISSEMENT
      - EXONERATION
      - SANS_TVA
      title: VATAccountingCode
      type: string
    VATCategory:
      description: |-
        Standardized VAT categories for Factur-X (EN 16931 standard).

        **Possible values:**
        - `S`: STANDARD - Standard VAT rate
        - `Z`: ZERO - Zero VAT rate
        - `E`: EXEMPT - VAT exemption
        - `AE`: REVERSE_CHARGE - Reverse charge (auto-liquidation)
        - `K`: INTRA_COMMUNITY - Intra-community supply
        - `G`: EXPORT - Export outside EU
        - `O`: OUT_OF_SCOPE - Outside VAT scope
        - `L`: CANARY_ISLANDS - Canary Islands VAT
        - `M`: CEUTA_MELILLA - Ceuta/Melilla VAT
      enum:
      - S
      - Z
      - E
      - AE
      - K
      - G
      - O
      - L
      - M
      title: VATCategory
      type: string
    VATLine:
      description: |-
        Represents a VAT breakdown line by rate.

        For exemptions (categories E, AE, K, G, O), the fields
        `exemption_reason` and `vatex_code` are required per EN16931.
      properties:
        taxable_amount:
          $ref: "#/components/schemas/TaxableAmount"
        vat_amount:
          $ref: "#/components/schemas/VATAmount"
        rate:
          nullable: true
          type: string
        manual_rate:
          $ref: "#/components/schemas/Manual_Rate"
        category:
          allOf:
          - $ref: "#/components/schemas/VATCategory"
          nullable: true
        exemption_reason:
          nullable: true
          type: string
        vatex_code:
          nullable: true
          type: string
      required:
      - taxable_amount
      - vat_amount
      title: VATLine
    FacturXInvoice:
      description: Data model for an invoice to be converted to Factur-X.
      example:
        invoiceNumber: FACT-2025-001
        invoiceDate: 2025-10-27
        paymentDueDate: 2025-11-27
        submissionMode: DEPOT_PDF_API
        recipient:
          name: Client Test SAS
          electronicAddress:
            identifier: "12345678901234"
            schemeId: "0225"
          postalAddress:
            lineOne: 456 Avenue des Champs
            postalCode: "69001"
            city: Lyon
            countryCode: FR
          executingServiceCode: SERVICE01
        supplier:
          name: Ma Soci√©t√© SAS
          supplierId: 12345
          siret: "12345678900001"
          vatNumber: FR12345678900
          iban: FR7630006000011234567890189
          electronicAddress:
            identifier: "12345678900001"
            schemeId: "0225"
          postalAddress:
            lineOne: 123 Rue de la R√©publique
            lineTwo: B√¢timent A
            postalCode: "75001"
            city: Paris
            countryCode: FR
        invoicingFramework:
          invoicingFrameworkCode: A1_FACTURE_FOURNISSEUR
        references:
          invoiceType: FACTURE
          vatAccountingCode: TVA_SUR_DEBIT
          paymentMeans: VIREMENT
          invoiceCurrency: EUR
          purchaseOrderReference: CMD-2025-042
        invoiceLines:
        - lineNumber: 1
          itemName: Prestation de conseil
          quantity: "5.00"
          unit: HEURE
          unitNetPrice: "200.00"
          lineNetAmount: "1000.00"
          manualVatRate: "20.00"
          vatCategory: S
          reference: REF-CONSEIL-001
        - lineNumber: 2
          itemName: Formation d√©veloppeurs
          quantity: "3.00"
          unit: JOUR
          unitNetPrice: "500.00"
          lineNetAmount: "1500.00"
          vatCategory: S
          manualVatRate: "20.00"
          reference: REF-FORM-002
        vatLines:
        - taxableAmount: "2500.00"
          vatAmount: "500.00"
          manualRate: "20.00"
          category: S
        totals:
          totalNetAmount: "2500.00"
          vatAmount: "500.00"
          totalGrossAmount: "3000.00"
          amountDue: "3000.00"
        comment: Invoice for October 2025 services
      properties:
        invoice_number:
          title: Invoice Number
          type: string
        payment_due_date:
          title: Payment Due Date
          type: string
        invoice_date:
          title: Invoice Date
          type: string
        submission_mode:
          $ref: "#/components/schemas/SubmissionMode"
        recipient:
          $ref: "#/components/schemas/Recipient"
        supplier:
          $ref: "#/components/schemas/Supplier"
        invoicing_framework:
          $ref: "#/components/schemas/InvoicingFramework"
        references:
          $ref: "#/components/schemas/InvoiceReferences"
        totals:
          $ref: "#/components/schemas/InvoiceTotals"
        invoice_lines:
          items:
            $ref: "#/components/schemas/InvoiceLine"
          type: array
        vat_lines:
          items:
            $ref: "#/components/schemas/VATLine"
          type: array
        notes:
          items:
            $ref: "#/components/schemas/InvoiceNote"
          type: array
        comment:
          nullable: true
          type: string
        current_user_id:
          nullable: true
          type: integer
        supplementary_attachments:
          items:
            $ref: "#/components/schemas/SupplementaryAttachment"
          nullable: true
          type: array
        payee:
          allOf:
          - $ref: "#/components/schemas/Payee"
          nullable: true
      required:
      - invoice_number
      - invoicing_framework
      - payment_due_date
      - recipient
      - references
      - submission_mode
      - supplier
      - totals
      title: FacturXInvoice
    PDPCredentials:
      description: |-
        PDP credentials for zero-storage strategy (Strategy B).

        Allows providing PDP credentials directly in the request
        instead of storing them in Django.

        Useful for:
        - Ad-hoc tests without persisting credentials
        - Temporary integrations
        - Development environments
      example:
        clientId: factpulse_prod_abc123
        clientSecret: secret_xyz789
        directoryServiceUrl: https://api.pdp-example.fr/directory/v1
        flowServiceUrl: https://api.pdp-example.fr/flow/v1
        tokenUrl: https://auth.pdp-example.fr/oauth/token
      properties:
        flow_service_url:
          description: Base URL of the AFNOR Flow Service
          example: https://api.pdp-example.fr/flow/v1
          title: Flow Service Url
          type: string
        directory_service_url:
          nullable: true
          type: string
        token_url:
          description: OAuth2 server URL
          example: https://auth.pdp-example.fr/oauth/token
          title: Token Url
          type: string
        client_id:
          description: OAuth2 Client ID
          example: factpulse_prod_abc123
          title: Client Id
          type: string
        client_secret:
          description: OAuth2 Client Secret (sensitive)
          example: secret_xyz789
          title: Client Secret
          type: string
      required:
      - client_id
      - client_secret
      - flow_service_url
      - token_url
      title: PDPCredentials
    FlowProfile:
      description: Supported flow profiles.
      enum:
      - Basic
      - CIUS
      - Extended-CTC-FR
      title: FlowProfile
      type: string
    FlowSyntax:
      description: Flow syntaxes supported by AFNOR.
      enum:
      - CII
      - UBL
      - Factur-X
      - CDAR
      - FRR
      title: FlowSyntax
      type: string
    SubmitFlowRequest:
      description: Request to submit an invoice to a PDP/PA via AFNOR.
      example:
        flowName: Invoice 2025-001
        flowProfile: CIUS
        flowSyntax: CII
        trackingId: TRACK-2025-001
      properties:
        flow_name:
          description: "Flow name (e.g., 'Invoice 2025-001')"
          example: Invoice 2025-001
          title: Flow Name
          type: string
        flow_syntax:
          allOf:
          - $ref: "#/components/schemas/FlowSyntax"
          default: CII
          description: Flow syntax (CII for Factur-X)
        flow_profile:
          allOf:
          - $ref: "#/components/schemas/FlowProfile"
          nullable: true
        tracking_id:
          nullable: true
          type: string
        request_id:
          nullable: true
          type: string
        pdp_credentials:
          allOf:
          - $ref: "#/components/schemas/PDPCredentials"
          nullable: true
      required:
      - flow_name
      title: SubmitFlowRequest
    AcknowledgmentStatus:
      description: Flow acknowledgment status.
      enum:
      - Pending
      - Ok
      - Error
      title: AcknowledgmentStatus
      type: string
    FlowDirection:
      description: Flow direction.
      enum:
      - In
      - Out
      title: FlowDirection
      type: string
    FlowType:
      description: Invoice flow types.
      enum:
      - CustomerInvoice
      - SupplierInvoice
      - CustomerInvoiceLC
      - SupplierInvoiceLC
      - eReporting
      title: FlowType
      type: string
    SearchFlowRequest:
      description: Request to search submitted flows.
      example:
        acknowledgmentStatus: Ok
        flowDirections:
        - Out
        flowTypes:
        - SupplierInvoice
        limit: 10
      properties:
        updated_after:
          format: date-time
          nullable: true
          type: string
        updated_before:
          format: date-time
          nullable: true
          type: string
        flow_types:
          items:
            $ref: "#/components/schemas/FlowType"
          nullable: true
          type: array
        flow_directions:
          items:
            $ref: "#/components/schemas/FlowDirection"
          nullable: true
          type: array
        tracking_id:
          nullable: true
          type: string
        flow_id:
          nullable: true
          type: string
        acknowledgment_status:
          allOf:
          - $ref: "#/components/schemas/AcknowledgmentStatus"
          nullable: true
        offset:
          default: 0
          description: Offset for pagination
          minimum: 0
          title: Offset
          type: integer
        limit:
          default: 25
          description: Maximum number of results (max 100)
          maximum: 100
          minimum: 1
          title: Limit
          type: integer
      title: SearchFlowRequest
    SubmitFlowResponse:
      description: Response after submitting a flow.
      example:
        flowId: 550e8400-e29b-41d4-a716-446655440000
        flowProfile: CIUS
        flowSyntax: CII
        message: ‚úì Invoice successfully submitted to PDP/PA
        name: Invoice 2025-001
        sha256: a3c5f1...
        trackingId: TRACK-2025-001
      properties:
        flow_id:
          description: Unique flow identifier generated by the PDP
          title: Flow Id
          type: string
        tracking_id:
          nullable: true
          type: string
        name:
          description: Flow name
          title: Name
          type: string
        flow_syntax:
          description: "Flow syntax (CII, UBL, etc.)"
          title: Flow Syntax
          type: string
        flow_profile:
          nullable: true
          type: string
        sha256:
          description: SHA256 hash of the submitted file
          title: Sha256
          type: string
        message:
          description: Confirmation message
          title: Message
          type: string
      required:
      - flow_id
      - flow_syntax
      - message
      - name
      - sha256
      title: SubmitFlowResponse
    FlowSummary:
      description: Summary of a flow in search results.
      properties:
        flow_id:
          title: Flow Id
          type: string
        tracking_id:
          nullable: true
          type: string
        name:
          title: Name
          type: string
        flow_type:
          nullable: true
          type: string
        flow_direction:
          nullable: true
          type: string
        acknowledgment_status:
          nullable: true
          type: string
        created_at:
          nullable: true
          type: string
        updated_at:
          nullable: true
          type: string
      required:
      - flow_id
      - name
      title: FlowSummary
    SearchFlowResponse:
      description: Response from a flow search.
      example:
        limit: 25
        offset: 0
        results:
        - acknowledgmentStatus: Ok
          flowDirection: Out
          flowId: 550e8400-e29b-41d4-a716-446655440000
          flowType: SupplierInvoice
          name: Invoice 2025-001
          trackingId: TRACK-2025-001
        total: 42
      properties:
        total:
          description: Total number of results
          title: Total
          type: integer
        offset:
          description: Applied offset
          title: Offset
          type: integer
        limit:
          description: Results limit
          title: Limit
          type: integer
        results:
          description: List of found flows
          items:
            $ref: "#/components/schemas/FlowSummary"
          type: array
      required:
      - limit
      - offset
      - results
      - total
      title: SearchFlowResponse
    AFNORHealthCheckResponse:
      description: Response from AFNOR services healthcheck.
      example:
        directoryServiceOk: true
        flowServiceOk: true
        message: ‚úì AFNOR services operational
      properties:
        flow_service_ok:
          description: Flow Service API status
          title: Flow Service Ok
          type: boolean
        directory_service_ok:
          description: Directory Service API status
          title: Directory Service Ok
          type: boolean
        message:
          description: Descriptive status message
          title: Message
          type: string
      required:
      - directory_service_ok
      - flow_service_ok
      - message
      title: AFNORHealthCheckResponse
    InvoiceTypeCode:
      description: |-
        Document type according to BR-FR-04 (UNTDID 1001 codes).

        | Code | Name | Description |
        |------|------|-------------|
        | 380 | INVOICE | Commercial invoice |
        | 389 | SELF_BILLED_INVOICE | Self-billed invoice |
        | 393 | FACTORED_INVOICE | Factored invoice |
        | 501 | SELF_BILLED_FACTORED_INVOICE | Self-billed factored invoice |
        | 386 | PREPAYMENT_INVOICE | Prepayment invoice |
        | 500 | SELF_BILLED_PREPAYMENT_INVOICE | Self-billed prepayment invoice |
        | 384 | CORRECTIVE_INVOICE | Corrective invoice |
        | 471 | SELF_BILLED_CORRECTIVE_INVOICE | Self-billed corrective invoice |
        | 472 | FACTORED_CORRECTIVE_INVOICE | Factored corrective invoice |
        | 473 | SELF_BILLED_FACTORED_CORRECTIVE_INVOICE | Self-billed factored corrective invoice |
        | 381 | CREDIT_NOTE | Credit note |
        | 261 | SELF_BILLED_CREDIT_NOTE | Self-billed credit note |
        | 262 | GLOBAL_ALLOWANCE_CREDIT_NOTE | Credit note for global allowance |
        | 396 | FACTORED_CREDIT_NOTE | Factored credit note |
        | 502 | SELF_BILLED_FACTORED_CREDIT_NOTE | Self-billed factored credit note |
        | 503 | PREPAYMENT_CREDIT_NOTE | Credit note for prepayment invoice |
      enum:
      - "380"
      - "389"
      - "393"
      - "501"
      - "386"
      - "500"
      - "384"
      - "471"
      - "472"
      - "473"
      - "381"
      - "261"
      - "262"
      - "396"
      - "502"
      - "503"
      title: InvoiceTypeCode
      type: string
      x-enum-varnames:
      - INVOICE
      - SELF_BILLED_INVOICE
      - FACTORED_INVOICE
      - SELF_BILLED_FACTORED_INVOICE
      - PREPAYMENT_INVOICE
      - SELF_BILLED_PREPAYMENT_INVOICE
      - CORRECTIVE_INVOICE
      - SELF_BILLED_CORRECTIVE_INVOICE
      - FACTORED_CORRECTIVE_INVOICE
      - SELF_BILLED_FACTORED_CORRECTIVE_INVOICE
      - CREDIT_NOTE
      - SELF_BILLED_CREDIT_NOTE
      - GLOBAL_ALLOWANCE_CREDIT_NOTE
      - FACTORED_CREDIT_NOTE
      - SELF_BILLED_FACTORED_CREDIT_NOTE
      - PREPAYMENT_CREDIT_NOTE
      x-enum-descriptions:
      - Commercial Invoice
      - Self-billed Invoice
      - Factored Invoice
      - Self-billed Factored Invoice
      - Prepayment Invoice
      - Self-billed Prepayment Invoice
      - Corrective Invoice
      - Self-billed Corrective Invoice
      - Factored Corrective Invoice
      - Self-billed Factored Corrective Invoice
      - Credit Note
      - Self-billed Credit Note
      - Global Allowance Credit Note
      - Factored Credit Note
      - Self-billed Factored Credit Note
      - Prepayment Credit Note
    generate_invoice_api_v1_processing_generate_invoice_post_request:
      $ref: "#/components/schemas/Body_generate_invoice_api_v1_processing_generate_invoice_post"
    Destination:
      description: Destination configuration (Chorus Pro or AFNOR)
      discriminator:
        mapping:
          afnor: "#/components/schemas/AFNORDestination"
          chorus_pro: "#/components/schemas/ChorusProDestination"
        propertyName: type
      oneOf:
      - $ref: "#/components/schemas/ChorusProDestination"
      - $ref: "#/components/schemas/AFNORDestination"
      title: Destination
    SubmitNetAmount:
      anyOf:
      - type: number
      - pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
        type: string
      description: Total net amount
      title: SubmitNetAmount
    SubmitVatAmount:
      anyOf:
      - type: number
      - pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
        type: string
      description: VAT amount
      title: SubmitVatAmount
    SubmitGrossAmount:
      anyOf:
      - type: number
      - pattern: "^(?!^[-+.]*$)[+-]?0*\\d*\\.?\\d*$"
        type: string
      description: Total gross amount
      title: SubmitGrossAmount
    ValidationError_loc_inner:
      anyOf:
      - type: string
      - type: integer
    Quantity:
      anyOf:
      - type: number
      - pattern: "^(?!^[-+.]*$)[+-]?0*(?:\\d{0,8}|(?=[\\d.]{1,13}0*$)\\d{0,8}\\.\\\
          d{0,4}0*$)"
        type: string
      description: Invoiced quantity for this line.
      title: Quantity
    UnitNetPrice:
      anyOf:
      - type: number
      - pattern: "^(?!^[-+.]*$)[+-]?0*(?:\\d{0,8}|(?=[\\d.]{1,13}0*$)\\d{0,8}\\.\\\
          d{0,4}0*$)"
        type: string
      description: Unit net price (before tax).
      title: UnitNetPrice
    InvoiceLine_allowanceAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Allowance amount before tax. (Accepte number, string ou integer)"
      format: decimal
      nullable: true
    LineNetAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Line net amount (quantity √ó unit price - allowance). (Accepte\
        \ number, string ou integer)"
      format: decimal
      title: LineNetAmount
    Manual_Vat_Rate:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Manual VAT rate value. (Accepte number, string ou integer)"
      format: decimal
      title: Manual Vat Rate
    TotalNetAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Total net amount (before tax). (Accepte number, string ou integer)"
      format: decimal
      title: TotalNetAmount
    TotalVATAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Total VAT amount. (Accepte number, string ou integer)"
      format: decimal
      title: TotalVATAmount
    TotalGrossAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Total gross amount (including tax). (Accepte number, string ou\
        \ integer)"
      format: decimal
      title: TotalGrossAmount
    AmountDue:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Amount due for payment. (Accepte number, string ou integer)"
      format: decimal
      title: AmountDue
    InvoiceTotals_prepayment:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Prepayment amount. (Accepte number, string ou integer)"
      format: decimal
      nullable: true
    GlobalAllowanceAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Global allowance amount (including tax). (Accepte number, string\
        \ ou integer)"
      format: decimal
      title: GlobalAllowanceAmount
    TaxableAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Taxable amount (base) for this VAT line. (Accepte number, string\
        \ ou integer)"
      format: decimal
      title: TaxableAmount
    VATAmount:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "VAT amount for this line. (Accepte number, string ou integer)"
      format: decimal
      title: VATAmount
    Manual_Rate:
      anyOf:
      - minimum: 0.0
        type: number
      - pattern: "^-?\\d+(\\.\\d{1,4})?$"
        type: string
      description: "Manual VAT rate value. (Accepte number, string ou integer)"
      format: decimal
      title: Manual Rate
  securitySchemes:
    HTTPBearer:
      scheme: bearer
      type: http

